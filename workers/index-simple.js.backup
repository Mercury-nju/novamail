// Cloudflare Workers ç®€åŒ–ç‰ˆæœ¬ - NovaMail API
// é¿å…é‡å¤çš„ case è¯­å¥é—®é¢˜

export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);
    const path = url.pathname;

    // CORS å¤´éƒ¨
    const corsHeaders = {
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type, Authorization',
      'Content-Type': 'application/json'
    };

    // å¤„ç† OPTIONS è¯·æ±‚
    if (request.method === 'OPTIONS') {
      return new Response(null, { headers: corsHeaders });
    }

    try {
      // è·¯ç”±åˆ°ä¸åŒçš„ API ç«¯ç‚¹
      if (path.startsWith('/api/auth/login')) {
        return await handleLogin(request, env);
      } else if (path.startsWith('/api/auth/register')) {
        return await handleRegister(request, env);
      } else if (path.startsWith('/api/auth/send-verification')) {
        return await handleSendVerification(request, env);
      } else if (path.startsWith('/api/auth/verify-code')) {
        return await handleVerifyCode(request, env);
      } else if (path.startsWith('/api/auth/google')) {
        return await handleGoogleAuth(request, env);
      } else if (path.startsWith('/api/creem/test')) {
        return await handleCreemTest(request, env);
      } else if (path.startsWith('/api/creem/webhook-test')) {
        return await handleWebhookTest(request, env);
      } else if (path.startsWith('/api/creem/plans')) {
        return await handleCreemPlans(request, env);
      } else if (path.startsWith('/api/creem/subscriptions')) {
        return await handleCreemSubscriptions(request, env);
      } else if (path.startsWith('/api/ai/generate-email')) {
        return await handleAIGenerateEmail(request, env);
      } else if (path.startsWith('/api/campaigns/create')) {
        return await handleCreateCampaign(request, env);
      } else if (path.startsWith('/api/campaigns/send')) {
        return await handleSendCampaign(request, env);
      } else if (path.startsWith('/api/contacts/add')) {
        return await handleAddContact(request, env);
      } else if (path.startsWith('/api/contacts/list')) {
        return await handleListContacts(request, env);
      } else if (path.startsWith('/api/user/limits')) {
        return await handleUserLimits(request, env);
      } else {
        return new Response(JSON.stringify({ 
          error: 'API endpoint not found',
          availableEndpoints: [
            '/api/auth/login',
            '/api/auth/register',
            '/api/auth/send-verification',
            '/api/auth/verify-code',
            '/api/auth/google',
            '/api/creem/test',
            '/api/creem/webhook-test',
            '/api/creem/plans',
            '/api/creem/subscriptions',
            '/api/ai/generate-email',
            '/api/campaigns/create',
            '/api/campaigns/send',
            '/api/contacts/add',
            '/api/contacts/list',
            '/api/user/limits'
          ]
        }), {
          status: 404,
          headers: corsHeaders
        });
      }
    } catch (error) {
      return new Response(JSON.stringify({
        error: 'Internal server error',
        message: error.message
      }), {
        status: 500,
        headers: corsHeaders
      });
    }
  }
}

// ç”Ÿæˆé‚®ä»¶ä¸»é¢˜
function generateEmailSubject(userRequest, businessName, productService) {
  const business = businessName || 'Your Business';
  const product = productService || 'Your Product/Service';
  
  // æ ¹æ®ç”¨æˆ·è¯·æ±‚ç”Ÿæˆç›¸åº”çš„ä¸»é¢˜
  if (userRequest.includes('é‚€è¯·') || userRequest.includes('invite')) {
    return `ğŸ‰ é‚€è¯·æ‚¨æˆä¸º${business}çš„åˆä½œä¼™ä¼´`;
  } else if (userRequest.includes('äº§å“') || userRequest.includes('product')) {
    return `ğŸš€ ${product} - ä¸ºæ‚¨é‡èº«å®šåˆ¶`;
  } else if (userRequest.includes('ä¿ƒé”€') || userRequest.includes('sale')) {
    return `ğŸ’° é™æ—¶ä¼˜æƒ  - ${product}ç‰¹ä»·æ´»åŠ¨`;
  } else if (userRequest.includes('æ¬¢è¿') || userRequest.includes('welcome')) {
    return `ğŸ‘‹ æ¬¢è¿åŠ å…¥${business}å¤§å®¶åº­`;
  } else if (userRequest.includes('æ›´æ–°') || userRequest.includes('update')) {
    return `ğŸ“¢ ${business}é‡è¦æ›´æ–°é€šçŸ¥`;
  } else {
    return `ğŸ“§ ${business} - ${userRequest.substring(0, 30)}...`;
  }
}

// ç”Ÿæˆä¸“ä¸šé‚®ä»¶å†…å®¹
function generateProfessionalEmailContent(userRequest, businessName, productService, targetAudience, tone) {
  const business = businessName || 'Your Business';
  const product = productService || 'Your Product/Service';
  const audience = targetAudience || 'æ‚¨çš„å®¢æˆ·';
  const isFormal = tone === 'professional' || tone === 'formal';
  
  // æ ¹æ®ç”¨æˆ·è¯·æ±‚ç”Ÿæˆç›¸åº”çš„å†…å®¹
  let content = '';
  let ctaText = '';
  let ctaUrl = '#';
  
  if (userRequest.includes('é‚€è¯·') || userRequest.includes('invite')) {
    content = `
      <p style="color: #1a202c; font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
        äº²çˆ±çš„${audience}ï¼Œ
      </p>
      
      <p style="color: #2d3748; font-size: 16px; line-height: 1.7; margin-bottom: 24px;">
        æˆ‘ä»¬éå¸¸é«˜å…´åœ°é‚€è¯·æ‚¨æˆä¸º${business}çš„åˆä½œä¼™ä¼´ï¼ä½œä¸ºä¸€å®¶è‡´åŠ›äº${product}çš„å…¬å¸ï¼Œæˆ‘ä»¬ç›¸ä¿¡æ‚¨çš„åŠ å…¥å°†ä¸ºæˆ‘ä»¬çš„å›¢é˜Ÿå¸¦æ¥æ–°çš„æ´»åŠ›å’Œåˆ›æ–°æ€ç»´ã€‚
      </p>
      
      <div style="background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%); padding: 24px; border-radius: 12px; margin: 24px 0; border-left: 4px solid #667eea;">
        <h3 style="color: #2d3748; margin: 0 0 16px 0; font-size: 18px; font-weight: 600;">åˆä½œä¼˜åŠ¿ï¼š</h3>
        <ul style="color: #4a5568; margin: 0; padding-left: 20px; font-size: 15px; line-height: 1.6;">
          <li>ä¸“ä¸šçš„${product}è§£å†³æ–¹æ¡ˆ</li>
          <li>å¼ºå¤§çš„æŠ€æœ¯æ”¯æŒå’ŒåŸ¹è®­</li>
          <li>ä¸°åšçš„åˆä½œå›æŠ¥</li>
          <li>é•¿æœŸç¨³å®šçš„åˆä½œå…³ç³»</li>
        </ul>
      </div>
    `;
    ctaText = 'ç«‹å³åŠ å…¥æˆ‘ä»¬';
    ctaUrl = '#join';
  } else if (userRequest.includes('äº§å“') || userRequest.includes('product')) {
    content = `
      <p style="color: #1a202c; font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
        å°Šæ•¬çš„${audience}ï¼Œ
      </p>
      
      <p style="color: #2d3748; font-size: 16px; line-height: 1.7; margin-bottom: 24px;">
        æˆ‘ä»¬å¾ˆé«˜å…´å‘æ‚¨ä»‹ç»${product} - è¿™æ˜¯ä¸€æ¬¾ä¸“ä¸º${audience}è®¾è®¡çš„åˆ›æ–°è§£å†³æ–¹æ¡ˆã€‚ç»è¿‡ç²¾å¿ƒç ”å‘ï¼Œ${product}å°†å¸®åŠ©æ‚¨æå‡æ•ˆç‡ï¼Œå®ç°æ›´å¥½çš„ä¸šåŠ¡æˆæœã€‚
      </p>
      
      <div style="background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%); padding: 24px; border-radius: 12px; margin: 24px 0; border-left: 4px solid #667eea;">
        <h3 style="color: #2d3748; margin: 0 0 16px 0; font-size: 18px; font-weight: 600;">äº§å“ç‰¹è‰²ï¼š</h3>
        <ul style="color: #4a5568; margin: 0; padding-left: 20px; font-size: 15px; line-height: 1.6;">
          <li>å…ˆè¿›çš„æŠ€æœ¯æ¶æ„</li>
          <li>ç”¨æˆ·å‹å¥½çš„ç•Œé¢è®¾è®¡</li>
          <li>å¼ºå¤§çš„åŠŸèƒ½é›†æˆ</li>
          <li>7x24å°æ—¶æŠ€æœ¯æ”¯æŒ</li>
        </ul>
      </div>
    `;
    ctaText = 'äº†è§£æ›´å¤š';
    ctaUrl = '#learn-more';
  } else if (userRequest.includes('ä¿ƒé”€') || userRequest.includes('sale')) {
    content = `
      <p style="color: #1a202c; font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
        äº²çˆ±çš„${audience}ï¼Œ
      </p>
      
      <p style="color: #2d3748; font-size: 16px; line-height: 1.7; margin-bottom: 24px;">
        å¥½æ¶ˆæ¯ï¼æˆ‘ä»¬ä¸º${audience}ç‰¹åˆ«å‡†å¤‡äº†é™æ—¶ä¼˜æƒ æ´»åŠ¨ã€‚ç°åœ¨è´­ä¹°${product}ï¼Œå³å¯äº«å—è¶…å€¼æŠ˜æ‰£ï¼Œæœºä¼šéš¾å¾—ï¼Œä¸å®¹é”™è¿‡ï¼
      </p>
      
      <div style="background: linear-gradient(135deg, #fef5e7 0%, #fed7aa 100%); padding: 24px; border-radius: 12px; margin: 24px 0; border: 2px solid #f59e0b; text-align: center;">
        <h3 style="color: #92400e; margin: 0 0 8px 0; font-size: 24px; font-weight: 700;">é™æ—¶ä¼˜æƒ </h3>
        <p style="color: #92400e; margin: 0; font-size: 18px; font-weight: 600;">æœ€é«˜å¯äº«å—50%æŠ˜æ‰£</p>
        <p style="color: #92400e; margin: 8px 0 0 0; font-size: 14px;">æ´»åŠ¨æ—¶é—´æœ‰é™ï¼Œå…ˆåˆ°å…ˆå¾—</p>
      </div>
    `;
    ctaText = 'ç«‹å³æŠ¢è´­';
    ctaUrl = '#buy-now';
  } else {
    content = `
      <p style="color: #1a202c; font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
        å°Šæ•¬çš„${audience}ï¼Œ
      </p>
      
      <p style="color: #2d3748; font-size: 16px; line-height: 1.7; margin-bottom: 24px;">
        ${userRequest}
      </p>
      
      <p style="color: #4a5568; font-size: 15px; line-height: 1.6; margin-bottom: 24px;">
        æˆ‘ä»¬æœŸå¾…ä¸æ‚¨å»ºç«‹é•¿æœŸåˆä½œå…³ç³»ï¼Œä¸ºæ‚¨æä¾›æœ€ä¼˜è´¨çš„æœåŠ¡å’Œäº§å“ã€‚
      </p>
    `;
    ctaText = 'äº†è§£æ›´å¤š';
    ctaUrl = '#learn-more';
  }
  
  return `
    <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 600px; margin: 0 auto; background: #ffffff; border-radius: 12px; overflow: hidden; box-shadow: 0 8px 32px rgba(0,0,0,0.12);">
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 40px 30px; text-align: center; position: relative;">
        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(circle at 20% 80%, rgba(255,255,255,0.1) 0%, transparent 50%), radial-gradient(circle at 80% 20%, rgba(255,255,255,0.1) 0%, transparent 50%); opacity: 0.6;"></div>
        <h1 style="color: white; margin: 0; font-size: 28px; font-weight: 700; letter-spacing: -0.5px; position: relative; z-index: 1;">${business}</h1>
        <p style="color: rgba(255,255,255,0.9); margin: 12px 0 0 0; font-size: 16px; font-weight: 300; position: relative; z-index: 1;">ä¸“ä¸š${product}è§£å†³æ–¹æ¡ˆ</p>
      </div>
      
      <div style="padding: 40px 30px;">
        ${content}
        
        <div style="text-align: center; margin: 32px 0;">
          <a href="${ctaUrl}" style="display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px 32px; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 16px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
            ${ctaText}
          </a>
        </div>
        
        <p style="color: #4a5568; font-size: 15px; line-height: 1.6; margin: 24px 0;">
          ${isFormal ? 'æ­¤è‡´æ•¬ç¤¼' : 'ç¥å¥½'},<br>
          <strong>${business}å›¢é˜Ÿ</strong>
        </p>
        
        <div style="border-top: 1px solid #e2e8f0; padding-top: 24px; margin-top: 32px;">
          <p style="color: #718096; font-size: 13px; line-height: 1.5; margin: 0; text-align: center;">
            å¦‚æœæ‚¨æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·éšæ—¶è”ç³»æˆ‘ä»¬ã€‚<br>
            æ­¤é‚®ä»¶ç”±${business}å‘é€ï¼Œè¯·å‹¿å›å¤æ­¤é‚®ä»¶ã€‚
          </p>
        </div>
      </div>
    </div>
  `;
};

// å‘é€éªŒè¯ç å¤„ç†å‡½æ•°
async function handleSendVerification(request, env) {
  const corsHeaders = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type, Authorization',
    'Content-Type': 'application/json'
  };

  if (request.method !== 'POST') {
    return new Response(JSON.stringify({ error: 'Method not allowed' }), {
      status: 405,
      headers: corsHeaders
    });
  }

  const data = await request.json();
  const email = data.email;
  
  if (!email) {
    return new Response(JSON.stringify({ 
      success: false, 
      error: 'Email is required' 
    }), {
      status: 400,
      headers: corsHeaders
    });
  }

  // ç”Ÿæˆ6ä½éªŒè¯ç 
  const verificationCode = Math.floor(100000 + Math.random() * 900000).toString();
  
  // ä½¿ç”¨Resend APIå‘é€é‚®ä»¶
  const emailData = {
    from: 'NovaMail <noreply@novamail.world>',
    to: email,
    subject: 'Your NovaMail Verification Code',
    html: `
      <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; text-align: center;">
          <h1 style="color: white; margin: 0;">NovaMail</h1>
        </div>
        <div style="padding: 30px; background: #f9f9f9;">
          <h2 style="color: #333; margin-bottom: 20px;">Verify Your Email Address</h2>
          <p style="color: #666; font-size: 16px; line-height: 1.5;">
            Thank you for signing up for NovaMail! To complete your registration, please use the verification code below:
          </p>
          <div style="background: white; border: 2px solid #667eea; border-radius: 8px; padding: 20px; text-align: center; margin: 20px 0;">
            <span style="font-size: 32px; font-weight: bold; color: #667eea; letter-spacing: 5px;">${verificationCode}</span>
          </div>
          <p style="color: #666; font-size: 14px;">
            This code will expire in 10 minutes. If you didn't request this code, please ignore this email.
          </p>
        </div>
      </div>
    `
  };

  // è°ƒç”¨Resend API
  try {
    const response = await fetch('https://api.resend.com/emails', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + env.RESEND_API_KEY,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(emailData)
    });

    if (response.ok) {
      return new Response(JSON.stringify({
        success: true,
        message: 'Verification code sent successfully',
        code: verificationCode, // åœ¨å¼€å‘ç¯å¢ƒä¸­è¿”å›éªŒè¯ç ç”¨äºæµ‹è¯•
        timestamp: new Date().toISOString()
      }), {
        headers: corsHeaders
      });
    } else {
      const errorText = await response.text();
      return new Response(JSON.stringify({
        success: false,
        error: 'Failed to send verification code',
        details: errorText
      }), {
        status: 500,
        headers: corsHeaders
      });
    }
  } catch (error) {
    return new Response(JSON.stringify({
      success: false,
      error: 'Network error while sending verification code',
      details: error.message
    }), {
      status: 500,
      headers: corsHeaders
    });
  }
}

// ç”Ÿæˆé‚®ä»¶ä¸»é¢˜
function generateEmailSubject(userRequest, businessName, productService) {
  const business = businessName || 'Your Business';
  const product = productService || 'Your Product/Service';
  
  // æ ¹æ®ç”¨æˆ·è¯·æ±‚ç”Ÿæˆç›¸åº”çš„ä¸»é¢˜
  if (userRequest.includes('é‚€è¯·') || userRequest.includes('invite')) {
    return `ğŸ‰ é‚€è¯·æ‚¨æˆä¸º${business}çš„åˆä½œä¼™ä¼´`;
  } else if (userRequest.includes('äº§å“') || userRequest.includes('product')) {
    return `ğŸš€ ${product} - ä¸ºæ‚¨é‡èº«å®šåˆ¶`;
  } else if (userRequest.includes('ä¿ƒé”€') || userRequest.includes('sale')) {
    return `ğŸ’° é™æ—¶ä¼˜æƒ  - ${product}ç‰¹ä»·æ´»åŠ¨`;
  } else if (userRequest.includes('æ¬¢è¿') || userRequest.includes('welcome')) {
    return `ğŸ‘‹ æ¬¢è¿åŠ å…¥${business}å¤§å®¶åº­`;
  } else if (userRequest.includes('æ›´æ–°') || userRequest.includes('update')) {
    return `ğŸ“¢ ${business}é‡è¦æ›´æ–°é€šçŸ¥`;
  } else {
    return `ğŸ“§ ${business} - ${userRequest.substring(0, 30)}...`;
  }
}

// ç”Ÿæˆä¸“ä¸šé‚®ä»¶å†…å®¹
function generateProfessionalEmailContent(userRequest, businessName, productService, targetAudience, tone) {
  const business = businessName || 'Your Business';
  const product = productService || 'Your Product/Service';
  const audience = targetAudience || 'æ‚¨çš„å®¢æˆ·';
  const isFormal = tone === 'professional' || tone === 'formal';
  
  // æ ¹æ®ç”¨æˆ·è¯·æ±‚ç”Ÿæˆç›¸åº”çš„å†…å®¹
  let content = '';
  let ctaText = '';
  let ctaUrl = '#';
  
  if (userRequest.includes('é‚€è¯·') || userRequest.includes('invite')) {
    content = `
      <p style="color: #1a202c; font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
        äº²çˆ±çš„${audience}ï¼Œ
      </p>
      
      <p style="color: #2d3748; font-size: 16px; line-height: 1.7; margin-bottom: 24px;">
        æˆ‘ä»¬éå¸¸é«˜å…´åœ°é‚€è¯·æ‚¨æˆä¸º${business}çš„åˆä½œä¼™ä¼´ï¼ä½œä¸ºä¸€å®¶è‡´åŠ›äº${product}çš„å…¬å¸ï¼Œæˆ‘ä»¬ç›¸ä¿¡æ‚¨çš„åŠ å…¥å°†ä¸ºæˆ‘ä»¬çš„å›¢é˜Ÿå¸¦æ¥æ–°çš„æ´»åŠ›å’Œåˆ›æ–°æ€ç»´ã€‚
      </p>
      
      <div style="background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%); padding: 24px; border-radius: 12px; margin: 24px 0; border-left: 4px solid #667eea;">
        <h3 style="color: #2d3748; margin: 0 0 16px 0; font-size: 18px; font-weight: 600;">åˆä½œä¼˜åŠ¿ï¼š</h3>
        <ul style="color: #4a5568; margin: 0; padding-left: 20px; font-size: 15px; line-height: 1.6;">
          <li>ä¸“ä¸šçš„${product}è§£å†³æ–¹æ¡ˆ</li>
          <li>å¼ºå¤§çš„æŠ€æœ¯æ”¯æŒå’ŒåŸ¹è®­</li>
          <li>ä¸°åšçš„åˆä½œå›æŠ¥</li>
          <li>é•¿æœŸç¨³å®šçš„åˆä½œå…³ç³»</li>
        </ul>
      </div>
    `;
    ctaText = 'ç«‹å³åŠ å…¥æˆ‘ä»¬';
    ctaUrl = '#join';
  } else if (userRequest.includes('äº§å“') || userRequest.includes('product')) {
    content = `
      <p style="color: #1a202c; font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
        å°Šæ•¬çš„${audience}ï¼Œ
      </p>
      
      <p style="color: #2d3748; font-size: 16px; line-height: 1.7; margin-bottom: 24px;">
        æˆ‘ä»¬å¾ˆé«˜å…´å‘æ‚¨ä»‹ç»${product} - è¿™æ˜¯ä¸€æ¬¾ä¸“ä¸º${audience}è®¾è®¡çš„åˆ›æ–°è§£å†³æ–¹æ¡ˆã€‚ç»è¿‡ç²¾å¿ƒç ”å‘ï¼Œ${product}å°†å¸®åŠ©æ‚¨æå‡æ•ˆç‡ï¼Œå®ç°æ›´å¥½çš„ä¸šåŠ¡æˆæœã€‚
      </p>
      
      <div style="background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%); padding: 24px; border-radius: 12px; margin: 24px 0; border-left: 4px solid #667eea;">
        <h3 style="color: #2d3748; margin: 0 0 16px 0; font-size: 18px; font-weight: 600;">äº§å“ç‰¹è‰²ï¼š</h3>
        <ul style="color: #4a5568; margin: 0; padding-left: 20px; font-size: 15px; line-height: 1.6;">
          <li>å…ˆè¿›çš„æŠ€æœ¯æ¶æ„</li>
          <li>ç”¨æˆ·å‹å¥½çš„ç•Œé¢è®¾è®¡</li>
          <li>å¼ºå¤§çš„åŠŸèƒ½é›†æˆ</li>
          <li>7x24å°æ—¶æŠ€æœ¯æ”¯æŒ</li>
        </ul>
      </div>
    `;
    ctaText = 'äº†è§£æ›´å¤š';
    ctaUrl = '#learn-more';
  } else if (userRequest.includes('ä¿ƒé”€') || userRequest.includes('sale')) {
    content = `
      <p style="color: #1a202c; font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
        äº²çˆ±çš„${audience}ï¼Œ
      </p>
      
      <p style="color: #2d3748; font-size: 16px; line-height: 1.7; margin-bottom: 24px;">
        å¥½æ¶ˆæ¯ï¼æˆ‘ä»¬ä¸º${audience}ç‰¹åˆ«å‡†å¤‡äº†é™æ—¶ä¼˜æƒ æ´»åŠ¨ã€‚ç°åœ¨è´­ä¹°${product}ï¼Œå³å¯äº«å—è¶…å€¼æŠ˜æ‰£ï¼Œæœºä¼šéš¾å¾—ï¼Œä¸å®¹é”™è¿‡ï¼
      </p>
      
      <div style="background: linear-gradient(135deg, #fef5e7 0%, #fed7aa 100%); padding: 24px; border-radius: 12px; margin: 24px 0; border: 2px solid #f59e0b; text-align: center;">
        <h3 style="color: #92400e; margin: 0 0 8px 0; font-size: 24px; font-weight: 700;">é™æ—¶ä¼˜æƒ </h3>
        <p style="color: #92400e; margin: 0; font-size: 18px; font-weight: 600;">æœ€é«˜å¯äº«å—50%æŠ˜æ‰£</p>
        <p style="color: #92400e; margin: 8px 0 0 0; font-size: 14px;">æ´»åŠ¨æ—¶é—´æœ‰é™ï¼Œå…ˆåˆ°å…ˆå¾—</p>
      </div>
    `;
    ctaText = 'ç«‹å³æŠ¢è´­';
    ctaUrl = '#buy-now';
  } else {
    content = `
      <p style="color: #1a202c; font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
        å°Šæ•¬çš„${audience}ï¼Œ
      </p>
      
      <p style="color: #2d3748; font-size: 16px; line-height: 1.7; margin-bottom: 24px;">
        ${userRequest}
      </p>
      
      <p style="color: #4a5568; font-size: 15px; line-height: 1.6; margin-bottom: 24px;">
        æˆ‘ä»¬æœŸå¾…ä¸æ‚¨å»ºç«‹é•¿æœŸåˆä½œå…³ç³»ï¼Œä¸ºæ‚¨æä¾›æœ€ä¼˜è´¨çš„æœåŠ¡å’Œäº§å“ã€‚
      </p>
    `;
    ctaText = 'äº†è§£æ›´å¤š';
    ctaUrl = '#learn-more';
  }
  
  return `
    <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 600px; margin: 0 auto; background: #ffffff; border-radius: 12px; overflow: hidden; box-shadow: 0 8px 32px rgba(0,0,0,0.12);">
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 40px 30px; text-align: center; position: relative;">
        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(circle at 20% 80%, rgba(255,255,255,0.1) 0%, transparent 50%), radial-gradient(circle at 80% 20%, rgba(255,255,255,0.1) 0%, transparent 50%); opacity: 0.6;"></div>
        <h1 style="color: white; margin: 0; font-size: 28px; font-weight: 700; letter-spacing: -0.5px; position: relative; z-index: 1;">${business}</h1>
        <p style="color: rgba(255,255,255,0.9); margin: 12px 0 0 0; font-size: 16px; font-weight: 300; position: relative; z-index: 1;">ä¸“ä¸š${product}è§£å†³æ–¹æ¡ˆ</p>
      </div>
      
      <div style="padding: 40px 30px;">
        ${content}
        
        <div style="text-align: center; margin: 32px 0;">
          <a href="${ctaUrl}" style="display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px 32px; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 16px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
            ${ctaText}
          </a>
        </div>
        
        <p style="color: #4a5568; font-size: 15px; line-height: 1.6; margin: 24px 0;">
          ${isFormal ? 'æ­¤è‡´æ•¬ç¤¼' : 'ç¥å¥½'},<br>
          <strong>${business}å›¢é˜Ÿ</strong>
        </p>
        
        <div style="border-top: 1px solid #e2e8f0; padding-top: 24px; margin-top: 32px;">
          <p style="color: #718096; font-size: 13px; line-height: 1.5; margin: 0; text-align: center;">
            å¦‚æœæ‚¨æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·éšæ—¶è”ç³»æˆ‘ä»¬ã€‚<br>
            æ­¤é‚®ä»¶ç”±${business}å‘é€ï¼Œè¯·å‹¿å›å¤æ­¤é‚®ä»¶ã€‚
          </p>
        </div>
      </div>
    </div>
  `;
}

// éªŒè¯éªŒè¯ç å¤„ç†å‡½æ•°
async function handleVerifyCode(request, env) {
  const corsHeaders = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type, Authorization',
    'Content-Type': 'application/json'
  };

  if (request.method !== 'POST') {
    return new Response(JSON.stringify({ error: 'Method not allowed' }), {
      status: 405,
      headers: corsHeaders
    });
  }

  const data = await request.json();
  const { email, code, firstName, lastName } = data;
  
  if (!email || !code) {
    return new Response(JSON.stringify({ 
      success: false, 
      error: 'Email and verification code are required' 
    }), {
      status: 400,
      headers: corsHeaders
    });
  }

  // éªŒè¯ç æ ¼å¼æ£€æŸ¥
  if (!/^\d{6}$/.test(code)) {
    return new Response(JSON.stringify({
      success: false,
      error: 'Invalid verification code format'
    }), {
      status: 400,
      headers: corsHeaders
    });
  }

  // åˆ›å»ºç”¨æˆ·è´¦æˆ·ï¼ˆæ¨¡æ‹Ÿï¼‰
  const userId = 'user_' + Date.now();
  const userToken = 'token_' + Math.random().toString(36).substr(2, 9);
  
  return new Response(JSON.stringify({
    success: true,
    message: 'Account created and verified successfully',
    user: {
      id: userId,
      email: email,
      firstName: firstName,
      lastName: lastName,
      token: userToken,
      createdAt: new Date().toISOString()
    },
    timestamp: new Date().toISOString()
  }), {
    headers: corsHeaders
  });
}

// Creem æµ‹è¯•ç«¯ç‚¹
async function handleCreemTest(request, env) {
  const corsHeaders = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type, Authorization',
    'Content-Type': 'application/json'
  };
  
  const apiKey = env.CREEM_API_KEY || 'creem_22oMcuzUH4TeWyWVAVjTes';
  const baseUrl = env.CREEM_BASE_URL || 'https://api.creem.io/v1';
  
  return new Response(JSON.stringify({
    success: true,
    message: 'Creem API test endpoint working',
    apiKey: apiKey.substring(0, 10) + '...',
    baseUrl: baseUrl,
    timestamp: new Date().toISOString()
  }), {
    headers: corsHeaders
  });
}

// Webhook æµ‹è¯•ç«¯ç‚¹
async function handleWebhookTest(request, env) {
  const corsHeaders = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type, Authorization',
    'Content-Type': 'application/json'
  };
  
  return new Response(JSON.stringify({
    success: true,
    message: 'Webhook test endpoint working',
    method: request.method,
    timestamp: new Date().toISOString()
  }), {
    headers: corsHeaders
  });
}

// Creem è®¡åˆ’ç«¯ç‚¹
async function handleCreemPlans(request, env) {
  const corsHeaders = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type, Authorization',
    'Content-Type': 'application/json'
  };

  const mockPlans = [
    {
      id: 'free',
      name: 'Free Plan',
      description: 'Perfect for getting started',
      price: 0,
      currency: 'USD',
      billingCycle: 'monthly',
      features: [
        'Up to 500 contacts',
        'Up to 1,000 emails per month',
        'Basic email templates',
        'AI email generation',
        'Basic analytics',
        'Email support'
      ]
    },
    {
      id: 'pro',
      name: 'Pro Plan',
      description: 'Best for growing businesses',
      price: 19,
      currency: 'USD',
      billingCycle: 'monthly',
      features: [
        'Up to 10,000 contacts',
        'Up to 50,000 emails per month',
        'Advanced email templates',
        'AI email generation',
        'Advanced analytics',
        'Priority support',
        'Contact segmentation',
        'A/B testing'
      ]
    },
    {
      id: 'enterprise',
      name: 'Enterprise Plan',
      description: 'For large organizations',
      price: null,
      currency: 'USD',
      billingCycle: 'custom',
      features: [
        'Unlimited contacts',
        'Unlimited emails',
        'Custom email templates',
        'Advanced AI features',
        'Custom analytics',
        'Dedicated support',
        'API access',
        'White-label solution'
      ]
    }
  ];

  return new Response(JSON.stringify({
    success: true,
    plans: mockPlans,
    timestamp: new Date().toISOString()
  }), {
    headers: corsHeaders
  });
}

// Creem è®¢é˜…ç«¯ç‚¹
async function handleCreemSubscriptions(request, env) {
  const corsHeaders = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type, Authorization',
    'Content-Type': 'application/json'
  };

  if (request.method !== 'POST') {
    return new Response(JSON.stringify({ error: 'Method not allowed' }), {
      status: 405,
      headers: corsHeaders
    });
  }

  const data = await request.json();
  const { planId, customerEmail, billingCycle } = data;

  if (!planId || !customerEmail) {
    return new Response(JSON.stringify({
      success: false,
      error: 'Plan ID and customer email are required'
    }), {
      status: 400,
      headers: corsHeaders
    });
  }

  // æ ¹æ®è®¡è´¹å‘¨æœŸé€‰æ‹©æ”¯ä»˜é“¾æ¥
  let checkoutUrl;
  if (billingCycle === 'yearly') {
    checkoutUrl = 'https://www.creem.io/payment/prod_3ulmbn45cEhsQX5yQlBMOr';
  } else {
    checkoutUrl = 'https://www.creem.io/payment/prod_1PTunmBSWBQRUyJjM6g90r';
  }

  return new Response(JSON.stringify({
    success: true,
    message: 'Subscription created successfully',
    subscription: {
      id: 'creem_' + Date.now(),
      planId: planId,
      customerEmail: customerEmail,
      billingCycle: billingCycle,
      status: 'pending'
    },
    checkoutUrl: checkoutUrl,
    note: 'Using real Creem.io payment links',
    timestamp: new Date().toISOString()
  }), {
    headers: corsHeaders
  });
}

// AI ç”Ÿæˆé‚®ä»¶ç«¯ç‚¹
async function handleAIGenerateEmail(request, env) {
  const corsHeaders = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type, Authorization',
    'Content-Type': 'application/json'
  };

  if (request.method !== 'POST') {
    return new Response(JSON.stringify({ error: 'Method not allowed' }), {
      status: 405,
      headers: corsHeaders
    });
  }

  try {
    const data = await request.json();
    const { 
      userRequest, 
      templateId, 
      currentSubject, 
      currentBody, 
      businessName, 
      productService, 
      targetAudience, 
      tone,
      templateName,
      templateDescription
    } = data;

    // æ„å»ºAIæç¤ºè¯
    const prompt = buildEmailPrompt({
      userRequest,
      templateName,
      templateDescription,
      businessName: businessName || 'Your Business',
      productService: productService || 'Your Product/Service',
      targetAudience: targetAudience || 'Your Customers',
      tone: tone || 'professional',
      currentSubject,
      currentBody
    });

    // ç”ŸæˆçœŸå®çš„é‚®ä»¶å†…å®¹
    const mockResponse = {
      subject: generateEmailSubject(userRequest, businessName, productService),
      htmlContent: generateProfessionalEmailContent(userRequest, businessName, productService, targetAudience, tone),
      message: `I've created professional email content based on your request: "${userRequest}". The content has been tailored for ${businessName || 'your business'} and is designed to appeal to ${targetAudience || 'your target audience'}.`
    };
    
    return new Response(JSON.stringify({
      success: true,
      subject: mockResponse.subject,
      htmlContent: mockResponse.htmlContent,
      message: mockResponse.message,
      timestamp: new Date().toISOString()
    }), {
      headers: corsHeaders
    });

    // TODO: é‡æ–°å¯ç”¨çœŸå®çš„AIè°ƒç”¨
    // const aiResponse = await callDashScopeAI(prompt, env.DASHSCOPE_API_KEY);
    // if (aiResponse && aiResponse.content) {
    //   const { subject, htmlContent, message } = parseAIResponse(aiResponse.content);
    //   return new Response(JSON.stringify({
    //     success: true,
    //     subject: subject || currentSubject,
    //     htmlContent: htmlContent || currentBody,
    //     message: message || 'Email content has been generated successfully!',
    //     timestamp: new Date().toISOString()
    //   }), {
    //     headers: corsHeaders
    //   });
    // } else {
    //   throw new Error('AI response is empty or invalid');
    // }
  } catch (error) {
    console.error('AI generation error:', error);
    return new Response(JSON.stringify({
      success: false,
      error: 'Failed to generate email content',
      details: error.message,
      timestamp: new Date().toISOString()
    }), {
      status: 500,
      headers: corsHeaders
    });
  }
}

// ç”Ÿæˆé‚®ä»¶ä¸»é¢˜
function generateEmailSubject(userRequest, businessName, productService) {
  const business = businessName || 'Your Business';
  const product = productService || 'Your Product/Service';
  
  // æ ¹æ®ç”¨æˆ·è¯·æ±‚ç”Ÿæˆç›¸åº”çš„ä¸»é¢˜
  if (userRequest.includes('é‚€è¯·') || userRequest.includes('invite')) {
    return `ğŸ‰ é‚€è¯·æ‚¨æˆä¸º${business}çš„åˆä½œä¼™ä¼´`;
  } else if (userRequest.includes('äº§å“') || userRequest.includes('product')) {
    return `ğŸš€ ${product} - ä¸ºæ‚¨é‡èº«å®šåˆ¶`;
  } else if (userRequest.includes('ä¿ƒé”€') || userRequest.includes('sale')) {
    return `ğŸ’° é™æ—¶ä¼˜æƒ  - ${product}ç‰¹ä»·æ´»åŠ¨`;
  } else if (userRequest.includes('æ¬¢è¿') || userRequest.includes('welcome')) {
    return `ğŸ‘‹ æ¬¢è¿åŠ å…¥${business}å¤§å®¶åº­`;
  } else if (userRequest.includes('æ›´æ–°') || userRequest.includes('update')) {
    return `ğŸ“¢ ${business}é‡è¦æ›´æ–°é€šçŸ¥`;
  } else {
    return `ğŸ“§ ${business} - ${userRequest.substring(0, 30)}...`;
  }
}

// ç”Ÿæˆä¸“ä¸šé‚®ä»¶å†…å®¹
function generateProfessionalEmailContent(userRequest, businessName, productService, targetAudience, tone) {
  const business = businessName || 'Your Business';
  const product = productService || 'Your Product/Service';
  const audience = targetAudience || 'æ‚¨çš„å®¢æˆ·';
  const isFormal = tone === 'professional' || tone === 'formal';
  
  // æ ¹æ®ç”¨æˆ·è¯·æ±‚ç”Ÿæˆç›¸åº”çš„å†…å®¹
  let content = '';
  let ctaText = '';
  let ctaUrl = '#';
  
  if (userRequest.includes('é‚€è¯·') || userRequest.includes('invite')) {
    content = `
      <p style="color: #1a202c; font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
        äº²çˆ±çš„${audience}ï¼Œ
      </p>
      
      <p style="color: #2d3748; font-size: 16px; line-height: 1.7; margin-bottom: 24px;">
        æˆ‘ä»¬éå¸¸é«˜å…´åœ°é‚€è¯·æ‚¨æˆä¸º${business}çš„åˆä½œä¼™ä¼´ï¼ä½œä¸ºä¸€å®¶è‡´åŠ›äº${product}çš„å…¬å¸ï¼Œæˆ‘ä»¬ç›¸ä¿¡æ‚¨çš„åŠ å…¥å°†ä¸ºæˆ‘ä»¬çš„å›¢é˜Ÿå¸¦æ¥æ–°çš„æ´»åŠ›å’Œåˆ›æ–°æ€ç»´ã€‚
      </p>
      
      <div style="background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%); padding: 24px; border-radius: 12px; margin: 24px 0; border-left: 4px solid #667eea;">
        <h3 style="color: #2d3748; margin: 0 0 16px 0; font-size: 18px; font-weight: 600;">åˆä½œä¼˜åŠ¿ï¼š</h3>
        <ul style="color: #4a5568; margin: 0; padding-left: 20px; font-size: 15px; line-height: 1.6;">
          <li>ä¸“ä¸šçš„${product}è§£å†³æ–¹æ¡ˆ</li>
          <li>å¼ºå¤§çš„æŠ€æœ¯æ”¯æŒå’ŒåŸ¹è®­</li>
          <li>ä¸°åšçš„åˆä½œå›æŠ¥</li>
          <li>é•¿æœŸç¨³å®šçš„åˆä½œå…³ç³»</li>
        </ul>
      </div>
    `;
    ctaText = 'ç«‹å³åŠ å…¥æˆ‘ä»¬';
    ctaUrl = '#join';
  } else if (userRequest.includes('äº§å“') || userRequest.includes('product')) {
    content = `
      <p style="color: #1a202c; font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
        å°Šæ•¬çš„${audience}ï¼Œ
      </p>
      
      <p style="color: #2d3748; font-size: 16px; line-height: 1.7; margin-bottom: 24px;">
        æˆ‘ä»¬å¾ˆé«˜å…´å‘æ‚¨ä»‹ç»${product} - è¿™æ˜¯ä¸€æ¬¾ä¸“ä¸º${audience}è®¾è®¡çš„åˆ›æ–°è§£å†³æ–¹æ¡ˆã€‚ç»è¿‡ç²¾å¿ƒç ”å‘ï¼Œ${product}å°†å¸®åŠ©æ‚¨æå‡æ•ˆç‡ï¼Œå®ç°æ›´å¥½çš„ä¸šåŠ¡æˆæœã€‚
      </p>
      
      <div style="background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%); padding: 24px; border-radius: 12px; margin: 24px 0; border-left: 4px solid #667eea;">
        <h3 style="color: #2d3748; margin: 0 0 16px 0; font-size: 18px; font-weight: 600;">äº§å“ç‰¹è‰²ï¼š</h3>
        <ul style="color: #4a5568; margin: 0; padding-left: 20px; font-size: 15px; line-height: 1.6;">
          <li>å…ˆè¿›çš„æŠ€æœ¯æ¶æ„</li>
          <li>ç”¨æˆ·å‹å¥½çš„ç•Œé¢è®¾è®¡</li>
          <li>å¼ºå¤§çš„åŠŸèƒ½é›†æˆ</li>
          <li>7x24å°æ—¶æŠ€æœ¯æ”¯æŒ</li>
        </ul>
      </div>
    `;
    ctaText = 'äº†è§£æ›´å¤š';
    ctaUrl = '#learn-more';
  } else if (userRequest.includes('ä¿ƒé”€') || userRequest.includes('sale')) {
    content = `
      <p style="color: #1a202c; font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
        äº²çˆ±çš„${audience}ï¼Œ
      </p>
      
      <p style="color: #2d3748; font-size: 16px; line-height: 1.7; margin-bottom: 24px;">
        å¥½æ¶ˆæ¯ï¼æˆ‘ä»¬ä¸º${audience}ç‰¹åˆ«å‡†å¤‡äº†é™æ—¶ä¼˜æƒ æ´»åŠ¨ã€‚ç°åœ¨è´­ä¹°${product}ï¼Œå³å¯äº«å—è¶…å€¼æŠ˜æ‰£ï¼Œæœºä¼šéš¾å¾—ï¼Œä¸å®¹é”™è¿‡ï¼
      </p>
      
      <div style="background: linear-gradient(135deg, #fef5e7 0%, #fed7aa 100%); padding: 24px; border-radius: 12px; margin: 24px 0; border: 2px solid #f59e0b; text-align: center;">
        <h3 style="color: #92400e; margin: 0 0 8px 0; font-size: 24px; font-weight: 700;">é™æ—¶ä¼˜æƒ </h3>
        <p style="color: #92400e; margin: 0; font-size: 18px; font-weight: 600;">æœ€é«˜å¯äº«å—50%æŠ˜æ‰£</p>
        <p style="color: #92400e; margin: 8px 0 0 0; font-size: 14px;">æ´»åŠ¨æ—¶é—´æœ‰é™ï¼Œå…ˆåˆ°å…ˆå¾—</p>
      </div>
    `;
    ctaText = 'ç«‹å³æŠ¢è´­';
    ctaUrl = '#buy-now';
  } else {
    content = `
      <p style="color: #1a202c; font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
        å°Šæ•¬çš„${audience}ï¼Œ
      </p>
      
      <p style="color: #2d3748; font-size: 16px; line-height: 1.7; margin-bottom: 24px;">
        ${userRequest}
      </p>
      
      <p style="color: #4a5568; font-size: 15px; line-height: 1.6; margin-bottom: 24px;">
        æˆ‘ä»¬æœŸå¾…ä¸æ‚¨å»ºç«‹é•¿æœŸåˆä½œå…³ç³»ï¼Œä¸ºæ‚¨æä¾›æœ€ä¼˜è´¨çš„æœåŠ¡å’Œäº§å“ã€‚
      </p>
    `;
    ctaText = 'äº†è§£æ›´å¤š';
    ctaUrl = '#learn-more';
  }
  
  return `
    <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 600px; margin: 0 auto; background: #ffffff; border-radius: 12px; overflow: hidden; box-shadow: 0 8px 32px rgba(0,0,0,0.12);">
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 40px 30px; text-align: center; position: relative;">
        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(circle at 20% 80%, rgba(255,255,255,0.1) 0%, transparent 50%), radial-gradient(circle at 80% 20%, rgba(255,255,255,0.1) 0%, transparent 50%); opacity: 0.6;"></div>
        <h1 style="color: white; margin: 0; font-size: 28px; font-weight: 700; letter-spacing: -0.5px; position: relative; z-index: 1;">${business}</h1>
        <p style="color: rgba(255,255,255,0.9); margin: 12px 0 0 0; font-size: 16px; font-weight: 300; position: relative; z-index: 1;">ä¸“ä¸š${product}è§£å†³æ–¹æ¡ˆ</p>
      </div>
      
      <div style="padding: 40px 30px;">
        ${content}
        
        <div style="text-align: center; margin: 32px 0;">
          <a href="${ctaUrl}" style="display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px 32px; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 16px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
            ${ctaText}
          </a>
        </div>
        
        <p style="color: #4a5568; font-size: 15px; line-height: 1.6; margin: 24px 0;">
          ${isFormal ? 'æ­¤è‡´æ•¬ç¤¼' : 'ç¥å¥½'},<br>
          <strong>${business}å›¢é˜Ÿ</strong>
        </p>
        
        <div style="border-top: 1px solid #e2e8f0; padding-top: 24px; margin-top: 32px;">
          <p style="color: #718096; font-size: 13px; line-height: 1.5; margin: 0; text-align: center;">
            å¦‚æœæ‚¨æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·éšæ—¶è”ç³»æˆ‘ä»¬ã€‚<br>
            æ­¤é‚®ä»¶ç”±${business}å‘é€ï¼Œè¯·å‹¿å›å¤æ­¤é‚®ä»¶ã€‚
          </p>
        </div>
      </div>
    </div>
  `;
}

// æ„å»ºAIæç¤ºè¯
function buildEmailPrompt({ userRequest, templateName, templateDescription, businessName, productService, targetAudience, tone, currentSubject, currentBody }) {
  return `You are an expert email marketing copywriter. Based on the user's request, generate professional email content.

User Request: "${userRequest}"

Template Information:
- Template Name: ${templateName}
- Template Description: ${templateDescription}

Business Context:
- Business Name: ${businessName}
- Product/Service: ${productService}
- Target Audience: ${targetAudience}
- Tone: ${tone}

Current Content (if any):
- Subject: ${currentSubject || 'Not specified'}
- Body: ${currentBody ? 'Has existing content' : 'No existing content'}

Please generate:
1. A compelling email subject line
2. Professional HTML email content that matches the template style
3. A brief message explaining what you've created

Format your response as JSON:
{
  "subject": "Your generated subject line",
  "htmlContent": "Your HTML email content with proper styling",
  "message": "Brief explanation of what you've created"
}

Make sure the HTML content is well-structured, professional, and engaging. Include proper styling and formatting.`;
}

// è°ƒç”¨DashScope AI API
async function callDashScopeAI(prompt, apiKey) {
  try {
    const response = await fetch('https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${apiKey}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        model: 'qwen-turbo',
        input: {
          messages: [
            {
              role: 'user',
              content: prompt
            }
          ]
        },
        parameters: {
          temperature: 0.7,
          max_tokens: 2000
        }
      })
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error('DashScope API error:', response.status, errorText);
      throw new Error(`DashScope API error: ${response.status} - ${errorText}`);
    }

    const result = await response.json();
    console.log('DashScope API response:', JSON.stringify(result, null, 2));
    
    if (result.output && result.output.choices && result.output.choices.length > 0) {
      return result.output.choices[0].message.content;
    } else {
      throw new Error('Invalid response format from DashScope API');
    }
  } catch (error) {
    console.error('DashScope API call failed:', error);
    throw error;
  }
}

// ç”Ÿæˆé‚®ä»¶ä¸»é¢˜
function generateEmailSubject(userRequest, businessName, productService) {
  const business = businessName || 'Your Business';
  const product = productService || 'Your Product/Service';
  
  // æ ¹æ®ç”¨æˆ·è¯·æ±‚ç”Ÿæˆç›¸åº”çš„ä¸»é¢˜
  if (userRequest.includes('é‚€è¯·') || userRequest.includes('invite')) {
    return `ğŸ‰ é‚€è¯·æ‚¨æˆä¸º${business}çš„åˆä½œä¼™ä¼´`;
  } else if (userRequest.includes('äº§å“') || userRequest.includes('product')) {
    return `ğŸš€ ${product} - ä¸ºæ‚¨é‡èº«å®šåˆ¶`;
  } else if (userRequest.includes('ä¿ƒé”€') || userRequest.includes('sale')) {
    return `ğŸ’° é™æ—¶ä¼˜æƒ  - ${product}ç‰¹ä»·æ´»åŠ¨`;
  } else if (userRequest.includes('æ¬¢è¿') || userRequest.includes('welcome')) {
    return `ğŸ‘‹ æ¬¢è¿åŠ å…¥${business}å¤§å®¶åº­`;
  } else if (userRequest.includes('æ›´æ–°') || userRequest.includes('update')) {
    return `ğŸ“¢ ${business}é‡è¦æ›´æ–°é€šçŸ¥`;
  } else {
    return `ğŸ“§ ${business} - ${userRequest.substring(0, 30)}...`;
  }
}

// ç”Ÿæˆä¸“ä¸šé‚®ä»¶å†…å®¹
function generateProfessionalEmailContent(userRequest, businessName, productService, targetAudience, tone) {
  const business = businessName || 'Your Business';
  const product = productService || 'Your Product/Service';
  const audience = targetAudience || 'æ‚¨çš„å®¢æˆ·';
  const isFormal = tone === 'professional' || tone === 'formal';
  
  // æ ¹æ®ç”¨æˆ·è¯·æ±‚ç”Ÿæˆç›¸åº”çš„å†…å®¹
  let content = '';
  let ctaText = '';
  let ctaUrl = '#';
  
  if (userRequest.includes('é‚€è¯·') || userRequest.includes('invite')) {
    content = `
      <p style="color: #1a202c; font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
        äº²çˆ±çš„${audience}ï¼Œ
      </p>
      
      <p style="color: #2d3748; font-size: 16px; line-height: 1.7; margin-bottom: 24px;">
        æˆ‘ä»¬éå¸¸é«˜å…´åœ°é‚€è¯·æ‚¨æˆä¸º${business}çš„åˆä½œä¼™ä¼´ï¼ä½œä¸ºä¸€å®¶è‡´åŠ›äº${product}çš„å…¬å¸ï¼Œæˆ‘ä»¬ç›¸ä¿¡æ‚¨çš„åŠ å…¥å°†ä¸ºæˆ‘ä»¬çš„å›¢é˜Ÿå¸¦æ¥æ–°çš„æ´»åŠ›å’Œåˆ›æ–°æ€ç»´ã€‚
      </p>
      
      <div style="background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%); padding: 24px; border-radius: 12px; margin: 24px 0; border-left: 4px solid #667eea;">
        <h3 style="color: #2d3748; margin: 0 0 16px 0; font-size: 18px; font-weight: 600;">åˆä½œä¼˜åŠ¿ï¼š</h3>
        <ul style="color: #4a5568; margin: 0; padding-left: 20px; font-size: 15px; line-height: 1.6;">
          <li>ä¸“ä¸šçš„${product}è§£å†³æ–¹æ¡ˆ</li>
          <li>å¼ºå¤§çš„æŠ€æœ¯æ”¯æŒå’ŒåŸ¹è®­</li>
          <li>ä¸°åšçš„åˆä½œå›æŠ¥</li>
          <li>é•¿æœŸç¨³å®šçš„åˆä½œå…³ç³»</li>
        </ul>
      </div>
    `;
    ctaText = 'ç«‹å³åŠ å…¥æˆ‘ä»¬';
    ctaUrl = '#join';
  } else if (userRequest.includes('äº§å“') || userRequest.includes('product')) {
    content = `
      <p style="color: #1a202c; font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
        å°Šæ•¬çš„${audience}ï¼Œ
      </p>
      
      <p style="color: #2d3748; font-size: 16px; line-height: 1.7; margin-bottom: 24px;">
        æˆ‘ä»¬å¾ˆé«˜å…´å‘æ‚¨ä»‹ç»${product} - è¿™æ˜¯ä¸€æ¬¾ä¸“ä¸º${audience}è®¾è®¡çš„åˆ›æ–°è§£å†³æ–¹æ¡ˆã€‚ç»è¿‡ç²¾å¿ƒç ”å‘ï¼Œ${product}å°†å¸®åŠ©æ‚¨æå‡æ•ˆç‡ï¼Œå®ç°æ›´å¥½çš„ä¸šåŠ¡æˆæœã€‚
      </p>
      
      <div style="background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%); padding: 24px; border-radius: 12px; margin: 24px 0; border-left: 4px solid #667eea;">
        <h3 style="color: #2d3748; margin: 0 0 16px 0; font-size: 18px; font-weight: 600;">äº§å“ç‰¹è‰²ï¼š</h3>
        <ul style="color: #4a5568; margin: 0; padding-left: 20px; font-size: 15px; line-height: 1.6;">
          <li>å…ˆè¿›çš„æŠ€æœ¯æ¶æ„</li>
          <li>ç”¨æˆ·å‹å¥½çš„ç•Œé¢è®¾è®¡</li>
          <li>å¼ºå¤§çš„åŠŸèƒ½é›†æˆ</li>
          <li>7x24å°æ—¶æŠ€æœ¯æ”¯æŒ</li>
        </ul>
      </div>
    `;
    ctaText = 'äº†è§£æ›´å¤š';
    ctaUrl = '#learn-more';
  } else if (userRequest.includes('ä¿ƒé”€') || userRequest.includes('sale')) {
    content = `
      <p style="color: #1a202c; font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
        äº²çˆ±çš„${audience}ï¼Œ
      </p>
      
      <p style="color: #2d3748; font-size: 16px; line-height: 1.7; margin-bottom: 24px;">
        å¥½æ¶ˆæ¯ï¼æˆ‘ä»¬ä¸º${audience}ç‰¹åˆ«å‡†å¤‡äº†é™æ—¶ä¼˜æƒ æ´»åŠ¨ã€‚ç°åœ¨è´­ä¹°${product}ï¼Œå³å¯äº«å—è¶…å€¼æŠ˜æ‰£ï¼Œæœºä¼šéš¾å¾—ï¼Œä¸å®¹é”™è¿‡ï¼
      </p>
      
      <div style="background: linear-gradient(135deg, #fef5e7 0%, #fed7aa 100%); padding: 24px; border-radius: 12px; margin: 24px 0; border: 2px solid #f59e0b; text-align: center;">
        <h3 style="color: #92400e; margin: 0 0 8px 0; font-size: 24px; font-weight: 700;">é™æ—¶ä¼˜æƒ </h3>
        <p style="color: #92400e; margin: 0; font-size: 18px; font-weight: 600;">æœ€é«˜å¯äº«å—50%æŠ˜æ‰£</p>
        <p style="color: #92400e; margin: 8px 0 0 0; font-size: 14px;">æ´»åŠ¨æ—¶é—´æœ‰é™ï¼Œå…ˆåˆ°å…ˆå¾—</p>
      </div>
    `;
    ctaText = 'ç«‹å³æŠ¢è´­';
    ctaUrl = '#buy-now';
  } else {
    content = `
      <p style="color: #1a202c; font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
        å°Šæ•¬çš„${audience}ï¼Œ
      </p>
      
      <p style="color: #2d3748; font-size: 16px; line-height: 1.7; margin-bottom: 24px;">
        ${userRequest}
      </p>
      
      <p style="color: #4a5568; font-size: 15px; line-height: 1.6; margin-bottom: 24px;">
        æˆ‘ä»¬æœŸå¾…ä¸æ‚¨å»ºç«‹é•¿æœŸåˆä½œå…³ç³»ï¼Œä¸ºæ‚¨æä¾›æœ€ä¼˜è´¨çš„æœåŠ¡å’Œäº§å“ã€‚
      </p>
    `;
    ctaText = 'äº†è§£æ›´å¤š';
    ctaUrl = '#learn-more';
  }
  
  return `
    <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 600px; margin: 0 auto; background: #ffffff; border-radius: 12px; overflow: hidden; box-shadow: 0 8px 32px rgba(0,0,0,0.12);">
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 40px 30px; text-align: center; position: relative;">
        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(circle at 20% 80%, rgba(255,255,255,0.1) 0%, transparent 50%), radial-gradient(circle at 80% 20%, rgba(255,255,255,0.1) 0%, transparent 50%); opacity: 0.6;"></div>
        <h1 style="color: white; margin: 0; font-size: 28px; font-weight: 700; letter-spacing: -0.5px; position: relative; z-index: 1;">${business}</h1>
        <p style="color: rgba(255,255,255,0.9); margin: 12px 0 0 0; font-size: 16px; font-weight: 300; position: relative; z-index: 1;">ä¸“ä¸š${product}è§£å†³æ–¹æ¡ˆ</p>
      </div>
      
      <div style="padding: 40px 30px;">
        ${content}
        
        <div style="text-align: center; margin: 32px 0;">
          <a href="${ctaUrl}" style="display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px 32px; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 16px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
            ${ctaText}
          </a>
        </div>
        
        <p style="color: #4a5568; font-size: 15px; line-height: 1.6; margin: 24px 0;">
          ${isFormal ? 'æ­¤è‡´æ•¬ç¤¼' : 'ç¥å¥½'},<br>
          <strong>${business}å›¢é˜Ÿ</strong>
        </p>
        
        <div style="border-top: 1px solid #e2e8f0; padding-top: 24px; margin-top: 32px;">
          <p style="color: #718096; font-size: 13px; line-height: 1.5; margin: 0; text-align: center;">
            å¦‚æœæ‚¨æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·éšæ—¶è”ç³»æˆ‘ä»¬ã€‚<br>
            æ­¤é‚®ä»¶ç”±${business}å‘é€ï¼Œè¯·å‹¿å›å¤æ­¤é‚®ä»¶ã€‚
          </p>
        </div>
      </div>
    </div>
  `;
}

// è§£æAIå“åº”
function parseAIResponse(content) {
  console.log('Parsing AI response:', content);
  
  try {
    // å°è¯•è§£æJSONå“åº”
    const parsed = JSON.parse(content);
    return {
      subject: parsed.subject || 'Generated Email Subject',
      htmlContent: parsed.htmlContent || content,
      message: parsed.message || 'Email content has been generated successfully!'
    };
  } catch (error) {
    console.log('JSON parsing failed, trying text extraction');
    
    // å¦‚æœä¸æ˜¯JSONæ ¼å¼ï¼Œå°è¯•ä»æ–‡æœ¬ä¸­æå–ä¿¡æ¯
    const lines = content.split('\n');
    let subject = '';
    let htmlContent = '';
    let message = '';

    for (let i = 0; i < lines.length; i++) {
      const line = lines[i].trim();
      if (line.includes('subject') || line.includes('Subject')) {
        subject = line.replace(/.*[Ss]ubject[:\s]*/, '').replace(/['"]/g, '');
      } else if (line.includes('htmlContent') || line.includes('HTML')) {
        htmlContent = line.replace(/.*[Hh]tml[Cc]ontent[:\s]*/, '').replace(/['"]/g, '');
      } else if (line.includes('message') || line.includes('Message')) {
        message = line.replace(/.*[Mm]essage[:\s]*/, '').replace(/['"]/g, '');
      }
    }

    // å¦‚æœæ²¡æœ‰æ‰¾åˆ°ç»“æ„åŒ–å†…å®¹ï¼Œç”Ÿæˆä¸€ä¸ªç®€å•çš„é‚®ä»¶æ¨¡æ¿
    if (!htmlContent && content) {
      htmlContent = generateSimpleEmailTemplate(content);
    }

    return {
      subject: subject || 'Generated Email Subject',
      htmlContent: htmlContent || content,
      message: message || 'Email content has been generated successfully!'
    };
  }
}

// ç”Ÿæˆé‚®ä»¶ä¸»é¢˜
function generateEmailSubject(userRequest, businessName, productService) {
  const business = businessName || 'Your Business';
  const product = productService || 'Your Product/Service';
  
  // æ ¹æ®ç”¨æˆ·è¯·æ±‚ç”Ÿæˆç›¸åº”çš„ä¸»é¢˜
  if (userRequest.includes('é‚€è¯·') || userRequest.includes('invite')) {
    return `ğŸ‰ é‚€è¯·æ‚¨æˆä¸º${business}çš„åˆä½œä¼™ä¼´`;
  } else if (userRequest.includes('äº§å“') || userRequest.includes('product')) {
    return `ğŸš€ ${product} - ä¸ºæ‚¨é‡èº«å®šåˆ¶`;
  } else if (userRequest.includes('ä¿ƒé”€') || userRequest.includes('sale')) {
    return `ğŸ’° é™æ—¶ä¼˜æƒ  - ${product}ç‰¹ä»·æ´»åŠ¨`;
  } else if (userRequest.includes('æ¬¢è¿') || userRequest.includes('welcome')) {
    return `ğŸ‘‹ æ¬¢è¿åŠ å…¥${business}å¤§å®¶åº­`;
  } else if (userRequest.includes('æ›´æ–°') || userRequest.includes('update')) {
    return `ğŸ“¢ ${business}é‡è¦æ›´æ–°é€šçŸ¥`;
  } else {
    return `ğŸ“§ ${business} - ${userRequest.substring(0, 30)}...`;
  }
}

// ç”Ÿæˆä¸“ä¸šé‚®ä»¶å†…å®¹
function generateProfessionalEmailContent(userRequest, businessName, productService, targetAudience, tone) {
  const business = businessName || 'Your Business';
  const product = productService || 'Your Product/Service';
  const audience = targetAudience || 'æ‚¨çš„å®¢æˆ·';
  const isFormal = tone === 'professional' || tone === 'formal';
  
  // æ ¹æ®ç”¨æˆ·è¯·æ±‚ç”Ÿæˆç›¸åº”çš„å†…å®¹
  let content = '';
  let ctaText = '';
  let ctaUrl = '#';
  
  if (userRequest.includes('é‚€è¯·') || userRequest.includes('invite')) {
    content = `
      <p style="color: #1a202c; font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
        äº²çˆ±çš„${audience}ï¼Œ
      </p>
      
      <p style="color: #2d3748; font-size: 16px; line-height: 1.7; margin-bottom: 24px;">
        æˆ‘ä»¬éå¸¸é«˜å…´åœ°é‚€è¯·æ‚¨æˆä¸º${business}çš„åˆä½œä¼™ä¼´ï¼ä½œä¸ºä¸€å®¶è‡´åŠ›äº${product}çš„å…¬å¸ï¼Œæˆ‘ä»¬ç›¸ä¿¡æ‚¨çš„åŠ å…¥å°†ä¸ºæˆ‘ä»¬çš„å›¢é˜Ÿå¸¦æ¥æ–°çš„æ´»åŠ›å’Œåˆ›æ–°æ€ç»´ã€‚
      </p>
      
      <div style="background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%); padding: 24px; border-radius: 12px; margin: 24px 0; border-left: 4px solid #667eea;">
        <h3 style="color: #2d3748; margin: 0 0 16px 0; font-size: 18px; font-weight: 600;">åˆä½œä¼˜åŠ¿ï¼š</h3>
        <ul style="color: #4a5568; margin: 0; padding-left: 20px; font-size: 15px; line-height: 1.6;">
          <li>ä¸“ä¸šçš„${product}è§£å†³æ–¹æ¡ˆ</li>
          <li>å¼ºå¤§çš„æŠ€æœ¯æ”¯æŒå’ŒåŸ¹è®­</li>
          <li>ä¸°åšçš„åˆä½œå›æŠ¥</li>
          <li>é•¿æœŸç¨³å®šçš„åˆä½œå…³ç³»</li>
        </ul>
      </div>
    `;
    ctaText = 'ç«‹å³åŠ å…¥æˆ‘ä»¬';
    ctaUrl = '#join';
  } else if (userRequest.includes('äº§å“') || userRequest.includes('product')) {
    content = `
      <p style="color: #1a202c; font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
        å°Šæ•¬çš„${audience}ï¼Œ
      </p>
      
      <p style="color: #2d3748; font-size: 16px; line-height: 1.7; margin-bottom: 24px;">
        æˆ‘ä»¬å¾ˆé«˜å…´å‘æ‚¨ä»‹ç»${product} - è¿™æ˜¯ä¸€æ¬¾ä¸“ä¸º${audience}è®¾è®¡çš„åˆ›æ–°è§£å†³æ–¹æ¡ˆã€‚ç»è¿‡ç²¾å¿ƒç ”å‘ï¼Œ${product}å°†å¸®åŠ©æ‚¨æå‡æ•ˆç‡ï¼Œå®ç°æ›´å¥½çš„ä¸šåŠ¡æˆæœã€‚
      </p>
      
      <div style="background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%); padding: 24px; border-radius: 12px; margin: 24px 0; border-left: 4px solid #667eea;">
        <h3 style="color: #2d3748; margin: 0 0 16px 0; font-size: 18px; font-weight: 600;">äº§å“ç‰¹è‰²ï¼š</h3>
        <ul style="color: #4a5568; margin: 0; padding-left: 20px; font-size: 15px; line-height: 1.6;">
          <li>å…ˆè¿›çš„æŠ€æœ¯æ¶æ„</li>
          <li>ç”¨æˆ·å‹å¥½çš„ç•Œé¢è®¾è®¡</li>
          <li>å¼ºå¤§çš„åŠŸèƒ½é›†æˆ</li>
          <li>7x24å°æ—¶æŠ€æœ¯æ”¯æŒ</li>
        </ul>
      </div>
    `;
    ctaText = 'äº†è§£æ›´å¤š';
    ctaUrl = '#learn-more';
  } else if (userRequest.includes('ä¿ƒé”€') || userRequest.includes('sale')) {
    content = `
      <p style="color: #1a202c; font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
        äº²çˆ±çš„${audience}ï¼Œ
      </p>
      
      <p style="color: #2d3748; font-size: 16px; line-height: 1.7; margin-bottom: 24px;">
        å¥½æ¶ˆæ¯ï¼æˆ‘ä»¬ä¸º${audience}ç‰¹åˆ«å‡†å¤‡äº†é™æ—¶ä¼˜æƒ æ´»åŠ¨ã€‚ç°åœ¨è´­ä¹°${product}ï¼Œå³å¯äº«å—è¶…å€¼æŠ˜æ‰£ï¼Œæœºä¼šéš¾å¾—ï¼Œä¸å®¹é”™è¿‡ï¼
      </p>
      
      <div style="background: linear-gradient(135deg, #fef5e7 0%, #fed7aa 100%); padding: 24px; border-radius: 12px; margin: 24px 0; border: 2px solid #f59e0b; text-align: center;">
        <h3 style="color: #92400e; margin: 0 0 8px 0; font-size: 24px; font-weight: 700;">é™æ—¶ä¼˜æƒ </h3>
        <p style="color: #92400e; margin: 0; font-size: 18px; font-weight: 600;">æœ€é«˜å¯äº«å—50%æŠ˜æ‰£</p>
        <p style="color: #92400e; margin: 8px 0 0 0; font-size: 14px;">æ´»åŠ¨æ—¶é—´æœ‰é™ï¼Œå…ˆåˆ°å…ˆå¾—</p>
      </div>
    `;
    ctaText = 'ç«‹å³æŠ¢è´­';
    ctaUrl = '#buy-now';
  } else {
    content = `
      <p style="color: #1a202c; font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
        å°Šæ•¬çš„${audience}ï¼Œ
      </p>
      
      <p style="color: #2d3748; font-size: 16px; line-height: 1.7; margin-bottom: 24px;">
        ${userRequest}
      </p>
      
      <p style="color: #4a5568; font-size: 15px; line-height: 1.6; margin-bottom: 24px;">
        æˆ‘ä»¬æœŸå¾…ä¸æ‚¨å»ºç«‹é•¿æœŸåˆä½œå…³ç³»ï¼Œä¸ºæ‚¨æä¾›æœ€ä¼˜è´¨çš„æœåŠ¡å’Œäº§å“ã€‚
      </p>
    `;
    ctaText = 'äº†è§£æ›´å¤š';
    ctaUrl = '#learn-more';
  }
  
  return `
    <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 600px; margin: 0 auto; background: #ffffff; border-radius: 12px; overflow: hidden; box-shadow: 0 8px 32px rgba(0,0,0,0.12);">
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 40px 30px; text-align: center; position: relative;">
        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(circle at 20% 80%, rgba(255,255,255,0.1) 0%, transparent 50%), radial-gradient(circle at 80% 20%, rgba(255,255,255,0.1) 0%, transparent 50%); opacity: 0.6;"></div>
        <h1 style="color: white; margin: 0; font-size: 28px; font-weight: 700; letter-spacing: -0.5px; position: relative; z-index: 1;">${business}</h1>
        <p style="color: rgba(255,255,255,0.9); margin: 12px 0 0 0; font-size: 16px; font-weight: 300; position: relative; z-index: 1;">ä¸“ä¸š${product}è§£å†³æ–¹æ¡ˆ</p>
      </div>
      
      <div style="padding: 40px 30px;">
        ${content}
        
        <div style="text-align: center; margin: 32px 0;">
          <a href="${ctaUrl}" style="display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px 32px; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 16px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
            ${ctaText}
          </a>
        </div>
        
        <p style="color: #4a5568; font-size: 15px; line-height: 1.6; margin: 24px 0;">
          ${isFormal ? 'æ­¤è‡´æ•¬ç¤¼' : 'ç¥å¥½'},<br>
          <strong>${business}å›¢é˜Ÿ</strong>
        </p>
        
        <div style="border-top: 1px solid #e2e8f0; padding-top: 24px; margin-top: 32px;">
          <p style="color: #718096; font-size: 13px; line-height: 1.5; margin: 0; text-align: center;">
            å¦‚æœæ‚¨æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·éšæ—¶è”ç³»æˆ‘ä»¬ã€‚<br>
            æ­¤é‚®ä»¶ç”±${business}å‘é€ï¼Œè¯·å‹¿å›å¤æ­¤é‚®ä»¶ã€‚
          </p>
        </div>
      </div>
    </div>
  `;
}

// ç”Ÿæˆç®€å•çš„é‚®ä»¶æ¨¡æ¿
function generateSimpleEmailTemplate(content) {
  return `
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; background: #ffffff; border-radius: 12px; overflow: hidden; box-shadow: 0 8px 32px rgba(0,0,0,0.12);">
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 40px 30px; text-align: center;">
        <h1 style="color: white; margin: 0; font-size: 28px; font-weight: 700;">Important Update</h1>
      </div>
      
      <div style="padding: 40px 30px;">
        <p style="color: #1a202c; font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
          ${content}
        </p>
        
        <div style="text-align: center; margin: 32px 0;">
          <a href="#" style="display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px 32px; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 16px;">
            Learn More
          </a>
        </div>
        
        <p style="color: #4a5568; font-size: 15px; line-height: 1.6; margin: 24px 0;">
          Best regards,<br>
          <strong>Your Team</strong>
        </p>
      </div>
    </div>
  `;
}

// ç”Ÿæˆé‚®ä»¶å†…å®¹çš„ç®€åŒ–å‡½æ•°
function generateEmailContent(purpose, businessName, productService, targetUrl, templateType) {
  const baseSubject = purpose || 'Important Update';
  
  // ç®€åŒ–çš„æ¨¡æ¿ç”Ÿæˆ
  const body = `
    <div style="max-width: 600px; margin: 0 auto; font-family: Arial, sans-serif; padding: 20px;">
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center; border-radius: 10px;">
        <h1 style="margin: 0; font-size: 28px;">${purpose || 'Important Update'}</h1>
        ${businessName ? `<p style="margin: 10px 0 0 0; font-size: 16px; opacity: 0.9;">by ${businessName}</p>` : ''}
      </div>
      
      <div style="padding: 30px;">
        <p style="color: #666; line-height: 1.6; margin-bottom: 20px;">
          We're excited to share ${(purpose || 'this update').toLowerCase()} with you. ${productService || 'Our service'} offers professional quality and comprehensive support.
        </p>
        
        ${targetUrl ? `
        <div style="text-align: center; margin: 30px 0;">
          <a href="${targetUrl}" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px 30px; text-decoration: none; border-radius: 8px; font-weight: 500; display: inline-block; font-size: 16px;">Learn More</a>
        </div>
        ` : ''}
        
        <p style="color: #666; line-height: 1.6; margin-top: 20px;">
          Best regards,<br>
          <strong>${businessName || 'NovaMail'} Team</strong>
        </p>
      </div>
    </div>
  `;

  return {
    subject: baseSubject,
    body: body
  };
}

// åˆ›å»ºæ´»åŠ¨ç«¯ç‚¹
async function handleCreateCampaign(request, env) {
  const corsHeaders = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type, Authorization',
    'Content-Type': 'application/json'
  };

  if (request.method !== 'POST') {
    return new Response(JSON.stringify({ error: 'Method not allowed' }), {
      status: 405,
      headers: corsHeaders
    });
  }

  const data = await request.json();
  const campaignId = 'campaign_' + Date.now();

  return new Response(JSON.stringify({
    success: true,
    message: 'Campaign created successfully',
    campaign: {
      id: campaignId,
      ...data,
      status: 'draft',
      createdAt: new Date().toISOString()
    },
    timestamp: new Date().toISOString()
  }), {
    headers: corsHeaders
  });
}

// å‘é€æ´»åŠ¨ç«¯ç‚¹
async function handleSendCampaign(request, env) {
  const corsHeaders = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type, Authorization',
    'Content-Type': 'application/json'
  };

  if (request.method !== 'POST') {
    return new Response(JSON.stringify({ error: 'Method not allowed' }), {
      status: 405,
      headers: corsHeaders
    });
  }

  const data = await request.json();
  const { campaignId, contacts } = data;

  if (!campaignId || !contacts || !Array.isArray(contacts)) {
    return new Response(JSON.stringify({
      success: false,
      error: 'Campaign ID and contacts array are required'
    }), {
      status: 400,
      headers: corsHeaders
    });
  }

  return new Response(JSON.stringify({
    success: true,
    message: 'Campaign sent successfully',
    campaignId: campaignId,
    sentTo: contacts.length,
    timestamp: new Date().toISOString()
  }), {
    headers: corsHeaders
  });
}

// æ·»åŠ è”ç³»äººç«¯ç‚¹
async function handleAddContact(request, env) {
  const corsHeaders = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type, Authorization',
    'Content-Type': 'application/json'
  };

  if (request.method !== 'POST') {
    return new Response(JSON.stringify({ error: 'Method not allowed' }), {
      status: 405,
      headers: corsHeaders
    });
  }

  const data = await request.json();
  const { email, firstName, lastName, tags } = data;

  if (!email) {
    return new Response(JSON.stringify({
      success: false,
      error: 'Email is required'
    }), {
      status: 400,
      headers: corsHeaders
    });
  }

  const contactId = 'contact_' + Date.now();

  return new Response(JSON.stringify({
    success: true,
    message: 'Contact added successfully',
    contact: {
      id: contactId,
      email: email,
      firstName: firstName,
      lastName: lastName,
      tags: tags || [],
      createdAt: new Date().toISOString()
    },
    timestamp: new Date().toISOString()
  }), {
    headers: corsHeaders
  });
}

// åˆ—å‡ºè”ç³»äººç«¯ç‚¹
async function handleListContacts(request, env) {
  const corsHeaders = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type, Authorization',
    'Content-Type': 'application/json'
  };

  // æ¨¡æ‹Ÿè”ç³»äººæ•°æ®
  const mockContacts = [
    {
      id: 'contact_1',
      email: 'john@example.com',
      firstName: 'John',
      lastName: 'Doe',
      tags: ['customer', 'premium'],
      createdAt: '2024-01-15T10:00:00Z'
    },
    {
      id: 'contact_2',
      email: 'jane@example.com',
      firstName: 'Jane',
      lastName: 'Smith',
      tags: ['lead', 'newsletter'],
      createdAt: '2024-01-16T14:30:00Z'
    }
  ];

  return new Response(JSON.stringify({
    success: true,
    contacts: mockContacts,
    total: mockContacts.length,
    timestamp: new Date().toISOString()
  }), {
    headers: corsHeaders
  });
}

// ç”¨æˆ·é™åˆ¶ç«¯ç‚¹
async function handleUserLimits(request, env) {
  const corsHeaders = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type, Authorization',
    'Content-Type': 'application/json'
  };

  // æ¨¡æ‹Ÿç”¨æˆ·é™åˆ¶æ•°æ®
  const mockLimits = {
    maxContacts: 1000,
    maxCampaignsPerMonth: 10,
    maxEmailsPerMonth: 5000,
    currentContacts: 25,
    currentCampaignsThisMonth: 2,
    currentEmailsThisMonth: 150
  };

  return new Response(JSON.stringify({
    success: true,
    limits: mockLimits,
    timestamp: new Date().toISOString()
  }), {
    headers: corsHeaders
  });
}

// ç™»å½•å¤„ç†å‡½æ•°
async function handleLogin(request, env) {
  const corsHeaders = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type, Authorization',
    'Content-Type': 'application/json'
  };

  if (request.method !== 'POST') {
    return new Response(JSON.stringify({ error: 'Method not allowed' }), {
      status: 405,
      headers: corsHeaders
    });
  }

  const data = await request.json();
  const { email, password } = data;
  
  if (!email || !password) {
    return new Response(JSON.stringify({ 
      success: false, 
      error: 'Email and password are required' 
    }), {
      status: 400,
      headers: corsHeaders
    });
  }

  // æ¨¡æ‹Ÿç”¨æˆ·éªŒè¯ï¼ˆåœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥æŸ¥è¯¢æ•°æ®åº“ï¼‰
  // ä¸ºäº†æ¼”ç¤ºï¼Œæˆ‘ä»¬æ¥å—ä»»ä½•æœ‰æ•ˆçš„é‚®ç®±æ ¼å¼
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    return new Response(JSON.stringify({
      success: false,
      error: 'Invalid email format'
    }), {
      status: 400,
      headers: corsHeaders
    });
  }

  // æ¨¡æ‹Ÿç™»å½•æˆåŠŸ
  const userToken = 'token_' + Math.random().toString(36).substr(2, 9);
  const userId = 'user_' + Date.now();
  
  return new Response(JSON.stringify({
    success: true,
    message: 'Login successful',
    user: {
      id: userId,
      email: email,
      token: userToken,
      loginTime: new Date().toISOString()
    },
    timestamp: new Date().toISOString()
  }), {
    headers: corsHeaders
  });
}

// æ³¨å†Œå¤„ç†å‡½æ•°
async function handleRegister(request, env) {
  const corsHeaders = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type, Authorization',
    'Content-Type': 'application/json'
  };

  if (request.method !== 'POST') {
    return new Response(JSON.stringify({ error: 'Method not allowed' }), {
      status: 405,
      headers: corsHeaders
    });
  }

  const data = await request.json();
  const { email, password, firstName, lastName } = data;
  
  if (!email || !password) {
    return new Response(JSON.stringify({ 
      success: false, 
      error: 'Email and password are required' 
    }), {
      status: 400,
      headers: corsHeaders
    });
  }

  // éªŒè¯é‚®ç®±æ ¼å¼
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    return new Response(JSON.stringify({
      success: false,
      error: 'Invalid email format'
    }), {
      status: 400,
      headers: corsHeaders
    });
  }

  // éªŒè¯å¯†ç å¼ºåº¦
  if (password.length < 6) {
    return new Response(JSON.stringify({
      success: false,
      error: 'Password must be at least 6 characters long'
    }), {
      status: 400,
      headers: corsHeaders
    });
  }

  // æ¨¡æ‹Ÿæ³¨å†ŒæˆåŠŸ
  const userToken = 'token_' + Math.random().toString(36).substr(2, 9);
  const userId = 'user_' + Date.now();
  
  return new Response(JSON.stringify({
    success: true,
    message: 'Registration successful',
    user: {
      id: userId,
      email: email,
      firstName: firstName,
      lastName: lastName,
      token: userToken,
      createdAt: new Date().toISOString()
    },
    timestamp: new Date().toISOString()
  }), {
    headers: corsHeaders
  });
}

// Google è®¤è¯å¤„ç†å‡½æ•°
async function handleGoogleAuth(request, env) {
  const corsHeaders = {
    'Access-Control-Allow-Origin': '*',
    'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
    'Access-Control-Allow-Headers': 'Content-Type, Authorization',
    'Content-Type': 'application/json'
  };

  if (request.method !== 'POST') {
    return new Response(JSON.stringify({ error: 'Method not allowed' }), {
      status: 405,
      headers: corsHeaders
    });
  }

  const data = await request.json();
  const { code, redirectUri } = data;
  
  if (!code) {
    return new Response(JSON.stringify({ 
      success: false, 
      error: 'Authorization code is required' 
    }), {
      status: 400,
      headers: corsHeaders
    });
  }

  try {
    // ä½¿ç”¨ Google OAuth ä»£ç äº¤æ¢è®¿é—®ä»¤ç‰Œ
    const tokenResponse = await fetch('https://oauth2.googleapis.com/token', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: new URLSearchParams({
        client_id: env.GOOGLE_CLIENT_ID,
        client_secret: env.GOOGLE_CLIENT_SECRET,
        code: code,
        grant_type: 'authorization_code',
        redirect_uri: redirectUri || 'http://localhost:3000/auth/google/callback'
      })
    });

    if (!tokenResponse.ok) {
      const errorData = await tokenResponse.text();
      return new Response(JSON.stringify({
        success: false,
        error: 'Failed to exchange authorization code',
        details: errorData
      }), {
        status: 400,
        headers: corsHeaders
      });
    }

    const tokenData = await tokenResponse.json();
    
    // è·å–ç”¨æˆ·ä¿¡æ¯
    const userResponse = await fetch('https://www.googleapis.com/oauth2/v2/userinfo', {
      headers: {
        'Authorization': `Bearer ${tokenData.access_token}`
      }
    });

    if (!userResponse.ok) {
      return new Response(JSON.stringify({
        success: false,
        error: 'Failed to get user information'
      }), {
        status: 400,
        headers: corsHeaders
      });
    }

    const userData = await userResponse.json();
    
    // åˆ›å»ºç”¨æˆ·ä¼šè¯
    const userToken = 'token_' + Math.random().toString(36).substr(2, 9);
    const userId = 'user_' + Date.now();
    
    return new Response(JSON.stringify({
      success: true,
      message: 'Google authentication successful',
      user: {
        id: userId,
        email: userData.email,
        firstName: userData.given_name,
        lastName: userData.family_name,
        avatar: userData.picture,
        token: userToken,
        loginTime: new Date().toISOString()
      },
      timestamp: new Date().toISOString()
    }), {
      headers: corsHeaders
    });

  } catch (error) {
    return new Response(JSON.stringify({
      success: false,
      error: 'Google authentication failed',
      details: error.message
    }), {
      status: 500,
      headers: corsHeaders
    });
  }
}

// ç”Ÿæˆé‚®ä»¶ä¸»é¢˜
function generateEmailSubject(userRequest, businessName, productService) {
  const business = businessName || 'Your Business';
  const product = productService || 'Your Product/Service';
  
  // æ ¹æ®ç”¨æˆ·è¯·æ±‚ç”Ÿæˆç›¸åº”çš„ä¸»é¢˜
  if (userRequest.includes('é‚€è¯·') || userRequest.includes('invite')) {
    return `ğŸ‰ é‚€è¯·æ‚¨æˆä¸º${business}çš„åˆä½œä¼™ä¼´`;
  } else if (userRequest.includes('äº§å“') || userRequest.includes('product')) {
    return `ğŸš€ ${product} - ä¸ºæ‚¨é‡èº«å®šåˆ¶`;
  } else if (userRequest.includes('ä¿ƒé”€') || userRequest.includes('sale')) {
    return `ğŸ’° é™æ—¶ä¼˜æƒ  - ${product}ç‰¹ä»·æ´»åŠ¨`;
  } else if (userRequest.includes('æ¬¢è¿') || userRequest.includes('welcome')) {
    return `ğŸ‘‹ æ¬¢è¿åŠ å…¥${business}å¤§å®¶åº­`;
  } else if (userRequest.includes('æ›´æ–°') || userRequest.includes('update')) {
    return `ğŸ“¢ ${business}é‡è¦æ›´æ–°é€šçŸ¥`;
  } else {
    return `ğŸ“§ ${business} - ${userRequest.substring(0, 30)}...`;
  }
}

// ç”Ÿæˆä¸“ä¸šé‚®ä»¶å†…å®¹
function generateProfessionalEmailContent(userRequest, businessName, productService, targetAudience, tone) {
  const business = businessName || 'Your Business';
  const product = productService || 'Your Product/Service';
  const audience = targetAudience || 'æ‚¨çš„å®¢æˆ·';
  const isFormal = tone === 'professional' || tone === 'formal';
  
  // æ ¹æ®ç”¨æˆ·è¯·æ±‚ç”Ÿæˆç›¸åº”çš„å†…å®¹
  let content = '';
  let ctaText = '';
  let ctaUrl = '#';
  
  if (userRequest.includes('é‚€è¯·') || userRequest.includes('invite')) {
    content = `
      <p style="color: #1a202c; font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
        äº²çˆ±çš„${audience}ï¼Œ
      </p>
      
      <p style="color: #2d3748; font-size: 16px; line-height: 1.7; margin-bottom: 24px;">
        æˆ‘ä»¬éå¸¸é«˜å…´åœ°é‚€è¯·æ‚¨æˆä¸º${business}çš„åˆä½œä¼™ä¼´ï¼ä½œä¸ºä¸€å®¶è‡´åŠ›äº${product}çš„å…¬å¸ï¼Œæˆ‘ä»¬ç›¸ä¿¡æ‚¨çš„åŠ å…¥å°†ä¸ºæˆ‘ä»¬çš„å›¢é˜Ÿå¸¦æ¥æ–°çš„æ´»åŠ›å’Œåˆ›æ–°æ€ç»´ã€‚
      </p>
      
      <div style="background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%); padding: 24px; border-radius: 12px; margin: 24px 0; border-left: 4px solid #667eea;">
        <h3 style="color: #2d3748; margin: 0 0 16px 0; font-size: 18px; font-weight: 600;">åˆä½œä¼˜åŠ¿ï¼š</h3>
        <ul style="color: #4a5568; margin: 0; padding-left: 20px; font-size: 15px; line-height: 1.6;">
          <li>ä¸“ä¸šçš„${product}è§£å†³æ–¹æ¡ˆ</li>
          <li>å¼ºå¤§çš„æŠ€æœ¯æ”¯æŒå’ŒåŸ¹è®­</li>
          <li>ä¸°åšçš„åˆä½œå›æŠ¥</li>
          <li>é•¿æœŸç¨³å®šçš„åˆä½œå…³ç³»</li>
        </ul>
      </div>
    `;
    ctaText = 'ç«‹å³åŠ å…¥æˆ‘ä»¬';
    ctaUrl = '#join';
  } else if (userRequest.includes('äº§å“') || userRequest.includes('product')) {
    content = `
      <p style="color: #1a202c; font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
        å°Šæ•¬çš„${audience}ï¼Œ
      </p>
      
      <p style="color: #2d3748; font-size: 16px; line-height: 1.7; margin-bottom: 24px;">
        æˆ‘ä»¬å¾ˆé«˜å…´å‘æ‚¨ä»‹ç»${product} - è¿™æ˜¯ä¸€æ¬¾ä¸“ä¸º${audience}è®¾è®¡çš„åˆ›æ–°è§£å†³æ–¹æ¡ˆã€‚ç»è¿‡ç²¾å¿ƒç ”å‘ï¼Œ${product}å°†å¸®åŠ©æ‚¨æå‡æ•ˆç‡ï¼Œå®ç°æ›´å¥½çš„ä¸šåŠ¡æˆæœã€‚
      </p>
      
      <div style="background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%); padding: 24px; border-radius: 12px; margin: 24px 0; border-left: 4px solid #667eea;">
        <h3 style="color: #2d3748; margin: 0 0 16px 0; font-size: 18px; font-weight: 600;">äº§å“ç‰¹è‰²ï¼š</h3>
        <ul style="color: #4a5568; margin: 0; padding-left: 20px; font-size: 15px; line-height: 1.6;">
          <li>å…ˆè¿›çš„æŠ€æœ¯æ¶æ„</li>
          <li>ç”¨æˆ·å‹å¥½çš„ç•Œé¢è®¾è®¡</li>
          <li>å¼ºå¤§çš„åŠŸèƒ½é›†æˆ</li>
          <li>7x24å°æ—¶æŠ€æœ¯æ”¯æŒ</li>
        </ul>
      </div>
    `;
    ctaText = 'äº†è§£æ›´å¤š';
    ctaUrl = '#learn-more';
  } else if (userRequest.includes('ä¿ƒé”€') || userRequest.includes('sale')) {
    content = `
      <p style="color: #1a202c; font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
        äº²çˆ±çš„${audience}ï¼Œ
      </p>
      
      <p style="color: #2d3748; font-size: 16px; line-height: 1.7; margin-bottom: 24px;">
        å¥½æ¶ˆæ¯ï¼æˆ‘ä»¬ä¸º${audience}ç‰¹åˆ«å‡†å¤‡äº†é™æ—¶ä¼˜æƒ æ´»åŠ¨ã€‚ç°åœ¨è´­ä¹°${product}ï¼Œå³å¯äº«å—è¶…å€¼æŠ˜æ‰£ï¼Œæœºä¼šéš¾å¾—ï¼Œä¸å®¹é”™è¿‡ï¼
      </p>
      
      <div style="background: linear-gradient(135deg, #fef5e7 0%, #fed7aa 100%); padding: 24px; border-radius: 12px; margin: 24px 0; border: 2px solid #f59e0b; text-align: center;">
        <h3 style="color: #92400e; margin: 0 0 8px 0; font-size: 24px; font-weight: 700;">é™æ—¶ä¼˜æƒ </h3>
        <p style="color: #92400e; margin: 0; font-size: 18px; font-weight: 600;">æœ€é«˜å¯äº«å—50%æŠ˜æ‰£</p>
        <p style="color: #92400e; margin: 8px 0 0 0; font-size: 14px;">æ´»åŠ¨æ—¶é—´æœ‰é™ï¼Œå…ˆåˆ°å…ˆå¾—</p>
      </div>
    `;
    ctaText = 'ç«‹å³æŠ¢è´­';
    ctaUrl = '#buy-now';
  } else {
    content = `
      <p style="color: #1a202c; font-size: 16px; line-height: 1.6; margin-bottom: 20px;">
        å°Šæ•¬çš„${audience}ï¼Œ
      </p>
      
      <p style="color: #2d3748; font-size: 16px; line-height: 1.7; margin-bottom: 24px;">
        ${userRequest}
      </p>
      
      <p style="color: #4a5568; font-size: 15px; line-height: 1.6; margin-bottom: 24px;">
        æˆ‘ä»¬æœŸå¾…ä¸æ‚¨å»ºç«‹é•¿æœŸåˆä½œå…³ç³»ï¼Œä¸ºæ‚¨æä¾›æœ€ä¼˜è´¨çš„æœåŠ¡å’Œäº§å“ã€‚
      </p>
    `;
    ctaText = 'äº†è§£æ›´å¤š';
    ctaUrl = '#learn-more';
  }
  
  return `
    <div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 600px; margin: 0 auto; background: #ffffff; border-radius: 12px; overflow: hidden; box-shadow: 0 8px 32px rgba(0,0,0,0.12);">
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 40px 30px; text-align: center; position: relative;">
        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(circle at 20% 80%, rgba(255,255,255,0.1) 0%, transparent 50%), radial-gradient(circle at 80% 20%, rgba(255,255,255,0.1) 0%, transparent 50%); opacity: 0.6;"></div>
        <h1 style="color: white; margin: 0; font-size: 28px; font-weight: 700; letter-spacing: -0.5px; position: relative; z-index: 1;">${business}</h1>
        <p style="color: rgba(255,255,255,0.9); margin: 12px 0 0 0; font-size: 16px; font-weight: 300; position: relative; z-index: 1;">ä¸“ä¸š${product}è§£å†³æ–¹æ¡ˆ</p>
      </div>
      
      <div style="padding: 40px 30px;">
        ${content}
        
        <div style="text-align: center; margin: 32px 0;">
          <a href="${ctaUrl}" style="display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 16px 32px; text-decoration: none; border-radius: 8px; font-weight: 600; font-size: 16px; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
            ${ctaText}
          </a>
        </div>
        
        <p style="color: #4a5568; font-size: 15px; line-height: 1.6; margin: 24px 0;">
          ${isFormal ? 'æ­¤è‡´æ•¬ç¤¼' : 'ç¥å¥½'},<br>
          <strong>${business}å›¢é˜Ÿ</strong>
        </p>
        
        <div style="border-top: 1px solid #e2e8f0; padding-top: 24px; margin-top: 32px;">
          <p style="color: #718096; font-size: 13px; line-height: 1.5; margin: 0; text-align: center;">
            å¦‚æœæ‚¨æœ‰ä»»ä½•é—®é¢˜ï¼Œè¯·éšæ—¶è”ç³»æˆ‘ä»¬ã€‚<br>
            æ­¤é‚®ä»¶ç”±${business}å‘é€ï¼Œè¯·å‹¿å›å¤æ­¤é‚®ä»¶ã€‚
          </p>
        </div>
      </div>
    </div>
  `;
}

