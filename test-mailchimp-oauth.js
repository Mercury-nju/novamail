/**
 * Mailchimp OAuth 完整流程测试
 * 测试从授权到模板导出的完整流程
 */

console.log('🧪 Mailchimp OAuth Test Suite')
console.log('=============================\n')

// 测试配置
const TEST_CONFIG = {
  baseUrl: 'https://novamail.pages.dev',
  testUserEmail: 'test@novamail.dev',
  testTemplate: {
    name: 'NovaMail OAuth Test Template',
    subject: 'OAuth Integration Test',
    html: `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="utf-8">
        <title>NovaMail OAuth Test</title>
        <style>
          body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
          .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 8px; text-align: center; }
          .content { padding: 20px; background: #f9f9f9; border-radius: 8px; margin: 20px 0; }
          .success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; padding: 15px; border-radius: 5px; margin: 20px 0; }
        </style>
      </head>
      <body>
        <div class="header">
          <h1>🎉 Mailchimp OAuth Integration Test</h1>
          <p>This template was created via OAuth integration</p>
        </div>
        
        <div class="content">
          <div class="success">
            ✅ <strong>OAuth Integration Successful!</strong>
          </div>
          
          <h2>Test Details:</h2>
          <ul>
            <li><strong>Platform:</strong> NovaMail</li>
            <li><strong>Integration:</strong> Mailchimp OAuth 2.0</li>
            <li><strong>User Account:</strong> Per-user isolation active</li>
            <li><strong>Status:</strong> Template exported successfully</li>
          </ul>
          
          <p><strong>Features Verified:</strong></p>
          <ul>
            <li>✅ OAuth authorization flow</li>
            <li>✅ Token storage in KV</li>
            <li>✅ Template creation in user's account</li>
            <li>✅ Data isolation between users</li>
          </ul>
        </div>
        
        <div style="text-align: center; color: #666; font-size: 14px; margin-top: 30px;">
          <p>Generated by NovaMail ESP Export System</p>
          <p>Timestamp: ${new Date().toLocaleString()}</p>
        </div>
      </body>
      </html>
    `
  }
}

// 测试1: 检查OAuth连接端点
async function testMailchimpConnect() {
  console.log('1️⃣ Testing Mailchimp Connect Endpoint...')
  
  try {
    const response = await fetch(`${TEST_CONFIG.baseUrl}/api/mailchimp/connect`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        userEmail: TEST_CONFIG.testUserEmail
      })
    })

    if (!response.ok) {
      throw new Error(`HTTP ${response.status}`)
    }

    const result = await response.json()
    
    if (result.success && result.auth_url) {
      console.log('✅ Mailchimp connect endpoint working!')
      console.log(`   Auth URL: ${result.auth_url}`)
      return true
    } else {
      console.log('❌ Unexpected response:', result)
      return false
    }
  } catch (error) {
    console.log('❌ Mailchimp connect failed:', error.message)
    return false
  }
}

// 测试2: 检查回调端点
async function testMailchimpCallback() {
  console.log('\n2️⃣ Testing Mailchimp Callback Endpoint...')
  
  try {
    const response = await fetch(`${TEST_CONFIG.baseUrl}/api/mailchimp/callback`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        code: 'test_code',
        userEmail: TEST_CONFIG.testUserEmail
      })
    })

    // 这个应该失败（因为test_code无效）
    if (!response.ok) {
      console.log('✅ Callback endpoint exists (failed as expected)')
      return true
    }
    
    console.log('⚠️  Unexpected success with test code')
    return false
  } catch (error) {
    console.log('❌ Callback endpoint error:', error.message)
    return false
  }
}

// 测试3: 检查导出端点（需要授权）
async function testExportEndpoint() {
  console.log('\n3️⃣ Testing Export Endpoint Configuration...')
  
  try {
    const response = await fetch(`${TEST_CONFIG.baseUrl}/api/export`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        esp: 'mailchimp',
        name: TEST_CONFIG.testTemplate.name,
        html: TEST_CONFIG.testTemplate.html,
        subject: TEST_CONFIG.testTemplate.subject,
        userEmail: TEST_CONFIG.testUserEmail
      })
    })

    const result = await response.json()
    
    // 应该返回未授权错误（因为用户还未连接）
    if (!result.success && (result.error.includes('未授权') || result.error.includes('not connected') || result.error.includes('authorized'))) {
      console.log('✅ Export endpoint configured correctly!')
      console.log(`   Error (expected): ${result.error}`)
      console.log('   User needs to connect Mailchimp account first')
      return true
    } else {
      console.log('⚠️  Unexpected response:', result)
      return false
    }
  } catch (error) {
    console.log('❌ Export endpoint error:', error.message)
    return false
  }
}

// 运行所有测试
async function runOAuthTests() {
  console.log('Starting OAuth Configuration Tests...\n')
  
  const results = {
    connect: await testMailchimpConnect(),
    callback: await testMailchimpCallback(),
    export: await testExportEndpoint()
  }
  
  console.log('\n📊 Test Results Summary:')
  console.log('========================')
  console.log(`Mailchimp Connect: ${results.connect ? '✅ PASS' : '❌ FAIL'}`)
  console.log(`Mailchimp Callback: ${results.callback ? '✅ PASS' : '❌ FAIL'}`)
  console.log(`Export Endpoint: ${results.export ? '✅ PASS' : '❌ FAIL'}`)
  
  const allPassed = Object.values(results).every(r => r)
  
  console.log('\n' + '='.repeat(50))
  if (allPassed) {
    console.log('✅ All OAuth configuration tests PASSED!')
    console.log('✅ Ready for production OAuth flow')
    console.log('\n💡 Next Step:')
    console.log('   Visit https://novamail.pages.dev/test-esp')
    console.log('   Click "Test Mailchimp" to test the full OAuth flow')
  } else {
    console.log('❌ Some tests FAILED')
    console.log('Please check the configuration')
  }
  console.log('='.repeat(50))
}

// 如果在浏览器环境
if (typeof window !== 'undefined') {
  window.runOAuthTests = runOAuthTests
  window.testMailchimpConnect = testMailchimpConnect
  console.log('\nTest functions available:')
  console.log('- runOAuthTests() - Run all OAuth tests')
  console.log('- testMailchimpConnect() - Test connect endpoint')
} else {
  runOAuthTests()
}
