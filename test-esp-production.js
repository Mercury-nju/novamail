/**
 * ESPå¯¼å‡ºåŠŸèƒ½æµ‹è¯•è„šæœ¬
 * æµ‹è¯•Mailchimpå’ŒResendçš„APIé›†æˆ
 */

// æµ‹è¯•é…ç½®
const TEST_CONFIG = {
  baseUrl: 'https://novamail.pages.dev',
  testUserEmail: 'test@example.com',
  testTemplate: {
    name: 'NovaMail Test Template',
    subject: 'Test Email from NovaMail',
    html: `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="utf-8">
        <title>NovaMail Test Template</title>
        <style>
          body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; }
          .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 8px; text-align: center; }
          .content { padding: 20px; background: #f9f9f9; border-radius: 8px; margin: 20px 0; }
          .footer { text-align: center; color: #666; font-size: 14px; }
        </style>
      </head>
      <body>
        <div class="header">
          <h1>ğŸš€ NovaMail ESP Export Test</h1>
          <p>Template successfully exported!</p>
        </div>
        
        <div class="content">
          <h2>Template Features:</h2>
          <ul>
            <li>âœ… Responsive design</li>
            <li>âœ… Modern gradient header</li>
            <li>âœ… Clean typography</li>
            <li>âœ… Professional layout</li>
            <li>âœ… ESP integration ready</li>
          </ul>
          
          <p>This template was created in NovaMail and exported to your ESP platform.</p>
        </div>
        
        <div class="footer">
          <p>Generated by NovaMail ESP Export System</p>
          <p>Timestamp: ${new Date().toLocaleString()}</p>
        </div>
      </body>
      </html>
    `
  }
}

// æµ‹è¯•Mailchimpå¯¼å‡º
async function testMailchimpExport() {
  console.log('ğŸ“§ Testing Mailchimp Export...')
  
  try {
    const response = await fetch(`${TEST_CONFIG.baseUrl}/api/export`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        esp: 'mailchimp',
        name: TEST_CONFIG.testTemplate.name,
        html: TEST_CONFIG.testTemplate.html,
        subject: TEST_CONFIG.testTemplate.subject,
        userEmail: TEST_CONFIG.testUserEmail
      })
    })

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`)
    }

    const result = await response.json()
    
    if (result.success) {
      console.log('âœ… Mailchimp export successful!')
      console.log(`   Template ID: ${result.id}`)
      console.log(`   Template Name: ${result.template_name}`)
      console.log(`   Edit URL: ${result.edit_url}`)
      console.log(`   ESP: ${result.esp}`)
      
      // è¯¢é—®æ˜¯å¦æ‰“å¼€ç¼–è¾‘é“¾æ¥
      const shouldOpen = confirm(
        `Mailchimp export successful!\n\nTemplate: ${result.template_name}\nID: ${result.id}\n\nWould you like to open the Mailchimp editor?`
      )
      
      if (shouldOpen) {
        window.open(result.edit_url, '_blank')
      }
      
      return true
    } else {
      console.log('âŒ Mailchimp export failed:', result.error)
      return false
    }
  } catch (error) {
    console.log('âŒ Mailchimp export error:', error.message)
    return false
  }
}

// æµ‹è¯•Resendå¯¼å‡º
async function testResendExport() {
  console.log('ğŸ“§ Testing Resend Export...')
  
  try {
    const response = await fetch(`${TEST_CONFIG.baseUrl}/api/export`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        esp: 'resend',
        name: TEST_CONFIG.testTemplate.name,
        html: TEST_CONFIG.testTemplate.html,
        subject: TEST_CONFIG.testTemplate.subject,
        userEmail: TEST_CONFIG.testUserEmail
      })
    })

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`)
    }

    const result = await response.json()
    
    if (result.success) {
      console.log('âœ… Resend export successful!')
      console.log(`   Template ID: ${result.id}`)
      console.log(`   Edit URL: ${result.edit_url}`)
    } else {
      console.log('âš ï¸  Resend export failed (expected):', result.error)
      if (result.error.includes('not supported')) {
        console.log('   âœ… This is the expected behavior - Resend does not support templates')
      }
    }
    
    return true
  } catch (error) {
    console.log('âŒ Resend export error:', error.message)
    return false
  }
}

// æµ‹è¯•APIç«¯ç‚¹å¯ç”¨æ€§
async function testAPIEndpoints() {
  console.log('ğŸ” Testing API Endpoints...')
  
  const endpoints = [
    '/api/export',
    '/api/mailchimp/connect',
    '/api/mailchimp/callback'
  ]
  
  for (const endpoint of endpoints) {
    try {
      const response = await fetch(`${TEST_CONFIG.baseUrl}${endpoint}`, {
        method: 'OPTIONS'
      })
      
      if (response.ok) {
        console.log(`âœ… ${endpoint} - Available`)
      } else {
        console.log(`âŒ ${endpoint} - Not available (${response.status})`)
      }
    } catch (error) {
      console.log(`âŒ ${endpoint} - Error: ${error.message}`)
    }
  }
}

// è¿è¡Œå®Œæ•´æµ‹è¯•
async function runESPExportTests() {
  console.log('ğŸš€ NovaMail ESP Export Test Suite')
  console.log('=====================================\n')
  
  // æµ‹è¯•APIç«¯ç‚¹
  await testAPIEndpoints()
  console.log('')
  
  // æµ‹è¯•Mailchimpå¯¼å‡º
  const mailchimpSuccess = await testMailchimpExport()
  console.log('')
  
  // æµ‹è¯•Resendå¯¼å‡º
  const resendSuccess = await testResendExport()
  console.log('')
  
  // æµ‹è¯•æ€»ç»“
  console.log('ğŸ“‹ Test Summary:')
  console.log('================')
  console.log(`Mailchimp Export: ${mailchimpSuccess ? 'âœ… Success' : 'âŒ Failed'}`)
  console.log(`Resend Export: ${resendSuccess ? 'âœ… Expected behavior' : 'âŒ Unexpected error'}`)
  
  console.log('\nğŸ’¡ Next Steps:')
  if (mailchimpSuccess) {
    console.log('âœ… Mailchimp integration is working perfectly!')
    console.log('âœ… Users can export templates to Mailchimp')
    console.log('âœ… Templates can be edited in Mailchimp')
  } else {
    console.log('âŒ Mailchimp integration needs debugging')
    console.log('âŒ Check API Key configuration')
  }
  
  console.log('\nğŸ¯ ESP Export Feature Status:')
  console.log('- Mailchimp: Ready for production')
  console.log('- Resend: Limited (no template support)')
  console.log('- SendGrid: Ready (when API key provided)')
}

// å¦‚æœåœ¨æµè§ˆå™¨ç¯å¢ƒä¸­è¿è¡Œ
if (typeof window !== 'undefined') {
  // æµè§ˆå™¨ç¯å¢ƒ
  window.testMailchimpExport = testMailchimpExport
  window.testResendExport = testResendExport
  window.runESPExportTests = runESPExportTests
  console.log('Test functions available:')
  console.log('- testMailchimpExport()')
  console.log('- testResendExport()')
  console.log('- runESPExportTests()')
} else {
  // Node.jsç¯å¢ƒ
  runESPExportTests().catch(console.error)
}
