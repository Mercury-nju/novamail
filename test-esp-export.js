/**
 * ESPå¯¼å‡ºåŠŸèƒ½æµ‹è¯•è„šæœ¬
 * ç”¨äºéªŒè¯APIç«¯ç‚¹çš„åŸºæœ¬åŠŸèƒ½
 */

// æµ‹è¯•é…ç½®
const TEST_CONFIG = {
  baseUrl: 'https://novamail.pages.dev', // æ›¿æ¢ä¸ºå®é™…åŸŸå
  testUserEmail: 'test@example.com',
  testTemplate: {
    name: 'Test Template',
    subject: 'Test Email Subject',
    html: `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="utf-8">
        <title>Test Template</title>
      </head>
      <body style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
        <h1 style="color: #333;">Hello World!</h1>
        <p>This is a test template exported from NovaMail.</p>
        <div style="background-color: #f0f0f0; padding: 15px; border-radius: 5px; margin: 20px 0;">
          <h2>Template Features:</h2>
          <ul>
            <li>Responsive design</li>
            <li>Clean typography</li>
            <li>Professional layout</li>
          </ul>
        </div>
        <p style="text-align: center; color: #666; font-size: 14px;">
          Generated by NovaMail ESP Export
        </p>
      </body>
      </html>
    `
  }
}

// æµ‹è¯•å‡½æ•°
async function testESPExport() {
  console.log('ğŸ§ª Starting ESP Export Tests...\n')

  // æµ‹è¯•1: Mailchimpè¿æ¥
  await testMailchimpConnect()
  
  // æµ‹è¯•2: SendGridå¯¼å‡º
  await testSendGridExport()
  
  // æµ‹è¯•3: Resendå¯¼å‡ºï¼ˆåº”è¯¥è¿”å›åŠŸèƒ½æœªæ”¯æŒï¼‰
  await testResendExport()
  
  console.log('\nâœ… All tests completed!')
}

// æµ‹è¯•Mailchimpè¿æ¥
async function testMailchimpConnect() {
  console.log('ğŸ“§ Testing Mailchimp Connect...')
  
  try {
    const response = await fetch(`${TEST_CONFIG.baseUrl}/api/mailchimp/connect`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        userEmail: TEST_CONFIG.testUserEmail
      })
    })

    const result = await response.json()
    
    if (result.success) {
      console.log('âœ… Mailchimp connect successful')
      console.log(`   Auth URL: ${result.auth_url}`)
    } else {
      console.log('âŒ Mailchimp connect failed:', result.error)
    }
  } catch (error) {
    console.log('âŒ Mailchimp connect error:', error.message)
  }
  
  console.log('')
}

// æµ‹è¯•SendGridå¯¼å‡º
async function testSendGridExport() {
  console.log('ğŸ“§ Testing SendGrid Export...')
  
  try {
    const response = await fetch(`${TEST_CONFIG.baseUrl}/api/export`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        esp: 'sendgrid',
        name: TEST_CONFIG.testTemplate.name,
        html: TEST_CONFIG.testTemplate.html,
        subject: TEST_CONFIG.testTemplate.subject,
        userEmail: TEST_CONFIG.testUserEmail
      })
    })

    const result = await response.json()
    
    if (result.success) {
      console.log('âœ… SendGrid export successful')
      console.log(`   Template ID: ${result.id}`)
      console.log(`   Edit URL: ${result.edit_url}`)
    } else {
      console.log('âŒ SendGrid export failed:', result.error)
    }
  } catch (error) {
    console.log('âŒ SendGrid export error:', error.message)
  }
  
  console.log('')
}

// æµ‹è¯•Resendå¯¼å‡º
async function testResendExport() {
  console.log('ğŸ“§ Testing Resend Export...')
  
  try {
    const response = await fetch(`${TEST_CONFIG.baseUrl}/api/export`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        esp: 'resend',
        name: TEST_CONFIG.testTemplate.name,
        html: TEST_CONFIG.testTemplate.html,
        subject: TEST_CONFIG.testTemplate.subject,
        userEmail: TEST_CONFIG.testUserEmail
      })
    })

    const result = await response.json()
    
    if (result.success) {
      console.log('âœ… Resend export successful')
      console.log(`   Template ID: ${result.id}`)
    } else {
      console.log('âš ï¸  Resend export failed (expected):', result.error)
    }
  } catch (error) {
    console.log('âŒ Resend export error:', error.message)
  }
  
  console.log('')
}

// æµ‹è¯•APIç«¯ç‚¹å¯ç”¨æ€§
async function testAPIEndpoints() {
  console.log('ğŸ” Testing API Endpoints Availability...\n')
  
  const endpoints = [
    '/api/export',
    '/api/mailchimp/connect',
    '/api/mailchimp/callback'
  ]
  
  for (const endpoint of endpoints) {
    try {
      const response = await fetch(`${TEST_CONFIG.baseUrl}${endpoint}`, {
        method: 'OPTIONS'
      })
      
      if (response.ok) {
        console.log(`âœ… ${endpoint} - Available`)
      } else {
        console.log(`âŒ ${endpoint} - Not available (${response.status})`)
      }
    } catch (error) {
      console.log(`âŒ ${endpoint} - Error: ${error.message}`)
    }
  }
  
  console.log('')
}

// è¿è¡Œæ‰€æœ‰æµ‹è¯•
async function runAllTests() {
  console.log('ğŸš€ NovaMail ESP Export Test Suite')
  console.log('=====================================\n')
  
  await testAPIEndpoints()
  await testESPExport()
  
  console.log('ğŸ“‹ Test Summary:')
  console.log('- API endpoints should be available')
  console.log('- Mailchimp connect should generate auth URL')
  console.log('- SendGrid export may fail without API key (expected)')
  console.log('- Resend export should return "not supported" message')
  console.log('\nğŸ’¡ Next steps:')
  console.log('1. Configure ESP API keys in Cloudflare Workers')
  console.log('2. Set up Mailchimp OAuth application')
  console.log('3. Test with real ESP credentials')
}

// å¦‚æœåœ¨æµè§ˆå™¨ç¯å¢ƒä¸­è¿è¡Œ
if (typeof window !== 'undefined') {
  // æµè§ˆå™¨ç¯å¢ƒ
  window.testESPExport = testESPExport
  window.runAllTests = runAllTests
  console.log('Test functions available: testESPExport(), runAllTests()')
} else {
  // Node.jsç¯å¢ƒ
  runAllTests().catch(console.error)
}
